<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milwaukee Vehicle Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;500;600;700;800&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --background: oklch(0.8452 0 0);
            --foreground: oklch(0.2393 0 0);
            --card: oklch(0.7572 0 0);
            --card-foreground: oklch(0.2393 0 0);
            --primary: oklch(0.40 0.19 27);
            --primary-foreground: oklch(1.0000 0 0);
            --secondary: oklch(0.4955 0.0896 126.1858);
            --secondary-foreground: oklch(1.0000 0 0);
            --muted: oklch(0.7826 0 0);
            --muted-foreground: oklch(0.35 0 0);
            --accent: oklch(0.5880 0.0993 245.7394);
            --accent-foreground: oklch(1.0000 0 0);
            --destructive: oklch(0.7076 0.1975 46.4558);
            --border: oklch(0.4313 0 0);
            --input: oklch(0.4313 0 0);
            --ring: oklch(0.40 0.19 27);
            --radius: 0px;
            --shadow-sm: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 1px 2px -1px hsl(0 0% 0% / 0.40);
            --shadow: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 1px 2px -1px hsl(0 0% 0% / 0.40);
            --shadow-md: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 2px 4px -1px hsl(0 0% 0% / 0.40);
            --shadow-lg: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 4px 6px -1px hsl(0 0% 0% / 0.40);
            --shadow-xl: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 8px 10px -1px hsl(0 0% 0% / 0.40);
        }

        .dark {
            --background: oklch(0.2178 0 0);
            --foreground: oklch(0.9067 0 0);
            --card: oklch(0.2850 0 0);
            --card-foreground: oklch(0.9067 0 0);
            --primary: oklch(0.65 0.21 27);
            --primary-foreground: oklch(1.0000 0 0);
            --secondary: oklch(0.6423 0.1467 133.0145);
            --secondary-foreground: oklch(0 0 0);
            --muted: oklch(0.2645 0 0);
            --muted-foreground: oklch(0.75 0 0);
            --accent: oklch(0.7482 0.1235 244.7492);
            --accent-foreground: oklch(0 0 0);
            --destructive: oklch(0.7839 0.1719 68.0943);
            --border: oklch(0.4091 0 0);
            --input: oklch(0.4091 0 0);
            --ring: oklch(0.65 0.21 27);
            --shadow-sm: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 1px 2px -1px hsl(0 0% 0% / 0.60);
            --shadow: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 1px 2px -1px hsl(0 0% 0% / 0.60);
            --shadow-md: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 2px 4px -1px hsl(0 0% 0% / 0.60);
            --shadow-lg: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 4px 6px -1px hsl(0 0% 0% / 0.60);
            --shadow-xl: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 8px 10px -1px hsl(0 0% 0% / 0.60);
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .scanlines,
            .scanlines::before,
            .scanlines::after {
                display: none !important;
            }
        }

        body {
            font-family: "Oxanium", sans-serif;
            background: var(--background);
            color: var(--foreground);
            line-height: 1.5;
            padding-bottom: 80px;
        }

        /* ---- DOOM ANIMATIONS ---- */
        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-8px, 6px) rotate(-1deg); }
            20% { transform: translate(10px, -8px) rotate(1deg); }
            30% { transform: translate(-12px, 10px) rotate(-1.5deg); }
            40% { transform: translate(8px, -6px) rotate(1deg); }
            50% { transform: translate(-10px, 8px) rotate(-1deg); }
            60% { transform: translate(12px, -10px) rotate(1.5deg); }
            70% { transform: translate(-6px, 8px) rotate(-0.5deg); }
            80% { transform: translate(8px, -4px) rotate(0.5deg); }
            90% { transform: translate(-4px, 6px) rotate(-0.5deg); }
        }
        body.shaking {
            animation: screenShake 500ms cubic-bezier(0.36, 0.07, 0.19, 0.97);
            overflow-x: hidden;
        }

        @keyframes slamDown {
            0% { transform: translateY(-200%) scale(1.2) rotateX(-15deg); opacity: 0; filter: blur(4px); }
            60% { transform: translateY(8%) scale(0.95) rotateX(2deg); opacity: 1; filter: blur(0); }
            80% { transform: translateY(-4%) scale(1.02) rotateX(-1deg); }
            100% { transform: translateY(0) scale(1) rotateX(0deg); opacity: 1; filter: blur(0); }
        }
        .slam-enter {
            animation: slamDown 600ms cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
            animation-delay: calc(var(--i, 0) * 50ms);
        }

        @keyframes glitchClip {
            0% { clip-path: inset(40% 0 61% 0); }
            20% { clip-path: inset(92% 0 1% 0); }
            40% { clip-path: inset(43% 0 1% 0); }
            60% { clip-path: inset(25% 0 58% 0); }
            80% { clip-path: inset(54% 0 7% 0); }
            100% { clip-path: inset(58% 0 43% 0); }
        }
        .glitch-text { position: relative; }
        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0.8;
        }
        .glitch-text::before {
            color: oklch(0.65 0.25 0);
            animation: glitchClip 650ms infinite;
            text-shadow: -3px 0 oklch(0.65 0.25 0);
            z-index: -1;
        }
        .glitch-text::after {
            color: oklch(0.7 0.2 240);
            animation: glitchClip 375ms infinite reverse;
            text-shadow: 3px 0 oklch(0.7 0.2 240);
            z-index: -2;
        }

        @keyframes fireBorder {
            0%, 100% { box-shadow: 0 0 20px oklch(0.6 0.25 30), 0 0 40px oklch(0.65 0.24 40), inset 0 0 20px oklch(0.5 0.2 30 / 0.3); }
            25% { box-shadow: 0 0 30px oklch(0.7 0.25 20), 0 0 60px oklch(0.65 0.24 40), inset 0 0 30px oklch(0.6 0.22 20 / 0.4); }
            50% { box-shadow: 0 0 25px oklch(0.75 0.26 50), 0 0 50px oklch(0.7 0.25 35), inset 0 0 25px oklch(0.65 0.2 50 / 0.35); }
            75% { box-shadow: 0 0 35px oklch(0.65 0.24 15), 0 0 70px oklch(0.6 0.23 45), inset 0 0 35px oklch(0.55 0.21 25 / 0.45); }
        }

        @keyframes redFlash {
            0%, 100% { opacity: 0; }
            10% { opacity: 0.8; }
            20% { opacity: 0.3; }
            30% { opacity: 0.9; }
            40% { opacity: 0; }
        }

        @keyframes pixelateIn {
            0% { transform: scale(0.5); filter: blur(8px) brightness(0.5); opacity: 0; }
            50% { filter: blur(4px) brightness(0.8); opacity: 0.7; }
            100% { transform: scale(1); filter: blur(0) brightness(1); opacity: 1; }
        }

        @keyframes countPop {
            0% { transform: scale(1); }
            25% { transform: scale(1.3) translateY(-4px); color: oklch(0.75 0.2 60); text-shadow: 0 0 10px oklch(0.75 0.2 60 / 0.6); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .stat-pop { animation: countPop 500ms cubic-bezier(0.68, -0.55, 0.27, 1.55); display: inline-block; }

        @keyframes scanlineFlicker {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.6; }
        }
        @keyframes scanlineMove {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes doomBarFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes doomPulseText {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes platformBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        /* ---- Weapon Impact Effects ---- */
        .weapon-impact {
            position: fixed;
            pointer-events: none;
            z-index: 9998;
        }

        /* Core flash - bright center of every explosion */
        .weapon-core {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Shockwave - expanding ring */
        .weapon-shockwave {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid;
            background: transparent;
        }

        /* Individual particle */
        .weapon-particle {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Weapon name HUD flash */
        .weapon-name-hud {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            font-family: "Oxanium", sans-serif;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #ffcc00;
            text-shadow: 0 0 10px #ff6600, 0 0 20px #ff4400, 2px 2px 0 #000;
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
            animation: weaponNameFlash 800ms ease-out forwards;
        }
        @keyframes weaponNameFlash {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.8); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.1); }
            30% { transform: translateX(-50%) translateY(0) scale(1); }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
        }

        /* Card hit flash - white overlay on the card when "hit" */
        .card-hit-flash {
            animation: cardHit 300ms ease-out;
        }
        @keyframes cardHit {
            0% { filter: brightness(3) saturate(0); }
            30% { filter: brightness(2) saturate(0.5); }
            100% { filter: brightness(1) saturate(1); }
        }

        /* --- Rocket Launcher --- */
        @keyframes rocketCore {
            0% { width: 12px; height: 12px; opacity: 1; background: radial-gradient(circle, #fff 0%, #ffdd44 30%, #ff6600 60%, #ff2200 100%); box-shadow: 0 0 40px #ff6600, 0 0 80px #ff4400, 0 0 120px #ff220088; }
            15% { width: 100px; height: 100px; background: radial-gradient(circle, #ffee88 0%, #ff8800 40%, #ff2200 80%); }
            40% { width: 150px; height: 150px; opacity: 0.8; background: radial-gradient(circle, #ffaa44 0%, #ff4400 50%, #880000 100%); box-shadow: 0 0 80px #ff2200, 0 0 140px #ff000088; }
            70% { width: 180px; height: 180px; opacity: 0.4; background: radial-gradient(circle, #ff6633 0%, #661100 60%, #220000 100%); }
            100% { width: 200px; height: 200px; opacity: 0; background: radial-gradient(circle, #331100 0%, #000 100%); box-shadow: none; }
        }
        @keyframes rocketShockwave {
            0% { width: 20px; height: 20px; opacity: 0.9; border-color: #ffcc44; border-width: 4px; box-shadow: 0 0 15px #ff880088; }
            50% { border-color: #ff660044; border-width: 2px; }
            100% { width: 320px; height: 320px; opacity: 0; border-color: transparent; border-width: 1px; box-shadow: none; }
        }
        @keyframes rocketParticle {
            0% { opacity: 1; transform: translate(-50%, -50%) translate(0, 0) scale(1); filter: blur(0); }
            20% { opacity: 1; filter: blur(0.5px); }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--px), var(--py)) scale(0.2); filter: blur(2px); }
        }
        @keyframes rocketSmoke {
            0% { opacity: 0.6; transform: translate(-50%, -50%) scale(0.3); background: radial-gradient(circle, #aaa 0%, #666 100%); filter: blur(2px); }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--sx), var(--sy)) scale(3); background: radial-gradient(circle, #555 0%, #111 100%); filter: blur(6px); }
        }
        @keyframes rocketTrail {
            0% { opacity: 0.8; width: var(--tw); height: 2px; background: linear-gradient(90deg, #ffcc44, #ff660000); }
            100% { opacity: 0; width: 0; height: 1px; background: linear-gradient(90deg, #ff440044, transparent); }
        }
        @keyframes rocketEmber {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 6px var(--ec); }
            60% { opacity: 0.8; }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--ex), var(--ey)) scale(0); box-shadow: none; }
        }

        /* --- Imp Fireball --- */
        @keyframes fireballCore {
            0% { width: 18px; height: 18px; opacity: 1; background: radial-gradient(circle, #ccff88 0%, #80ff40 30%, #40cc00 70%); box-shadow: 0 0 40px #40ff00, 0 0 80px #00cc00, 0 0 120px #00880088; }
            25% { width: 80px; height: 80px; background: radial-gradient(circle, #aaff66 0%, #60cc20 50%, #308000 100%); }
            50% { width: 110px; height: 110px; opacity: 0.7; background: radial-gradient(circle, #80cc40 0%, #408010 60%, #204000 100%); box-shadow: 0 0 50px #40800088; }
            100% { width: 150px; height: 150px; opacity: 0; background: radial-gradient(circle, #204000 0%, #000 100%); box-shadow: none; }
        }
        @keyframes fireballEmber {
            0% { opacity: 1; transform: translate(-50%, -50%) translate(0, 0) scale(1); background: radial-gradient(circle, #ccff88, #80ff40); box-shadow: 0 0 8px #40ff00; }
            40% { opacity: 0.9; background: radial-gradient(circle, #80cc40, #408010); }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--px), var(--py)) scale(0.1); background: #204000; box-shadow: none; filter: blur(2px); }
        }
        @keyframes fireballRing {
            0% { width: 10px; height: 10px; opacity: 0.8; border-color: #80ff40; box-shadow: 0 0 12px #40ff0066; }
            100% { width: 240px; height: 240px; opacity: 0; border-color: transparent; box-shadow: none; }
        }
        @keyframes fireballWisp {
            0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.5); background: radial-gradient(circle, #60cc2088, #40800000); filter: blur(3px); }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--wx), var(--wy)) scale(2.5); filter: blur(8px); }
        }

        /* --- Plasma Rifle --- */
        @keyframes plasmaCore {
            0% { width: 10px; height: 10px; opacity: 1; background: radial-gradient(circle, #fff 0%, #aaddff 30%, #4488ff 70%); box-shadow: 0 0 30px #44aaff, 0 0 60px #2266ff, 0 0 100px #1144aa88; }
            12% { width: 60px; height: 60px; background: radial-gradient(circle, #ddeeff 0%, #88ccff 40%, #4488ff 80%); }
            35% { width: 80px; height: 80px; opacity: 0.8; background: radial-gradient(circle, #aaccff 0%, #4488ff 50%, #223388 100%); box-shadow: 0 0 50px #2244cc88; }
            100% { width: 100px; height: 100px; opacity: 0; background: radial-gradient(circle, #224488 0%, #000 100%); box-shadow: none; }
        }
        @keyframes plasmaArc {
            0% { opacity: 1; width: 2px; height: 0; background: #88ddff; box-shadow: 0 0 10px #44aaff, 0 0 20px #2266ff44; }
            25% { height: var(--arc-len); opacity: 1; width: 3px; }
            100% { height: var(--arc-len); opacity: 0; width: 1px; background: #112244; box-shadow: none; }
        }
        @keyframes plasmaSpark {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); background: #ddeeff; box-shadow: 0 0 6px #44aaff; }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--px), var(--py)) scale(0); background: #224488; box-shadow: none; }
        }
        @keyframes plasmaRipple {
            0% { width: 8px; height: 8px; opacity: 0.6; border-color: #88ccff; box-shadow: 0 0 8px #44aaff44; }
            100% { width: 140px; height: 140px; opacity: 0; border-color: transparent; box-shadow: none; }
        }

        /* --- BFG 9000 --- */
        @keyframes bfgCore {
            0% { width: 25px; height: 25px; opacity: 1; background: radial-gradient(circle, #ffffff 0%, #aaffaa 20%, #44ff44 50%, #00cc22 80%); box-shadow: 0 0 60px #00ff44, 0 0 120px #00cc22, 0 0 200px #008811, 0 0 300px #00440088; }
            15% { width: 180px; height: 180px; background: radial-gradient(circle, #ccffcc 0%, #66ff66 30%, #22cc22 70%); }
            40% { width: 280px; height: 280px; opacity: 0.7; background: radial-gradient(circle, #88ff88 0%, #22aa22 50%, #005500 100%); }
            70% { width: 340px; height: 340px; opacity: 0.3; }
            100% { width: 400px; height: 400px; opacity: 0; background: radial-gradient(circle, #003300 0%, #000 100%); box-shadow: none; }
        }
        @keyframes bfgShockwave {
            0% { width: 30px; height: 30px; opacity: 1; border-color: #88ff88; border-width: 6px; box-shadow: 0 0 20px #00ff4488; }
            100% { width: 550px; height: 550px; opacity: 0; border-color: transparent; border-width: 1px; box-shadow: none; }
        }
        @keyframes bfgFlash {
            0% { opacity: 0; }
            8% { opacity: 0.5; }
            20% { opacity: 0.3; }
            40% { opacity: 0.15; }
            100% { opacity: 0; }
        }
        .bfg-screen-flash {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at var(--bfg-x, 50%) var(--bfg-y, 50%), #44ff44 0%, #00ff2244 40%, transparent 70%);
            mix-blend-mode: screen;
            pointer-events: none;
            z-index: 9997;
            animation: bfgFlash 800ms ease-out forwards;
        }
        @keyframes bfgSecondary {
            0% { width: 8px; height: 8px; opacity: 1; background: radial-gradient(circle, #ccffcc, #44ff44); box-shadow: 0 0 20px #00ff44; }
            40% { width: 50px; height: 50px; opacity: 0.7; }
            100% { width: 70px; height: 70px; opacity: 0; box-shadow: none; }
        }
        @keyframes bfgTendril {
            0% { opacity: 0.8; height: 0; }
            30% { height: var(--t-len); opacity: 0.8; }
            100% { height: var(--t-len); opacity: 0; }
        }

        /* --- Super Shotgun --- */
        @keyframes shotgunFlash {
            0% { width: 40px; height: 40px; opacity: 1; background: radial-gradient(circle, #fff 0%, #ffee88 40%, #ffcc00 80%); box-shadow: 0 0 40px #ffcc00, 0 0 80px #ff880088; }
            25% { width: 60px; height: 60px; background: radial-gradient(circle, #ffee88 0%, #ffaa00 50%, #ff6600 100%); }
            100% { width: 70px; height: 70px; opacity: 0; background: radial-gradient(circle, #ff6600 0%, #330000 100%); box-shadow: none; }
        }
        @keyframes shotgunPellet {
            0% { opacity: 1; transform: translate(-50%, -50%) translate(0, 0) scale(1); box-shadow: 0 0 4px var(--pc); }
            30% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--px), var(--py)) scale(0.2); box-shadow: none; filter: blur(1px); }
        }
        @keyframes shotgunSmokeRing {
            0% { width: 15px; height: 15px; opacity: 0.4; border-color: #aaa; filter: blur(1px); }
            100% { width: 120px; height: 120px; opacity: 0; border-color: transparent; filter: blur(4px); }
        }

        /* ---- CRT Scanlines Overlay ---- */
        .scanlines {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, transparent 0px, transparent 2px, oklch(0 0 0 / 0.08) 2px, oklch(0 0 0 / 0.08) 4px);
            pointer-events: none;
            z-index: 9999;
            opacity: 0.4;
            animation: scanlineFlicker 8s ease-in-out infinite;
        }
        .scanlines::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(180deg, transparent 0%, oklch(0 0 0 / 0.03) 50%, transparent 100%);
            animation: scanlineMove 12s linear infinite;
        }

        /* ---- Red Flash Overlay ---- */
        .red-flash-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: oklch(0.5 0.26 20);
            pointer-events: none;
            z-index: 10000;
            opacity: 0;
            mix-blend-mode: screen;
        }
        .red-flash-overlay.active { animation: redFlash 400ms cubic-bezier(0.4, 0, 0.2, 1); }

        /* ---- 3D Canvases ---- */
        #bg-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        #weapon-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9998;
        }

        /* ---- Header ---- */
        .header {
            background: var(--primary);
            color: var(--primary-foreground);
            padding: 2rem 1.5rem;
            text-align: center;
            border-bottom: 3px solid var(--border);
        }
        .header-inner {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-text { text-align: left; }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }
        .header p { opacity: 0.8; font-size: 0.85rem; font-weight: 400; }
        .header-buttons { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .theme-toggle, .sound-toggle {
            background: none;
            border: 2px solid var(--primary-foreground);
            color: var(--primary-foreground);
            width: 40px; height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            flex-shrink: 0;
            transition: opacity 0.15s;
        }
        .theme-toggle:hover, .sound-toggle:hover { opacity: 0.7; }

        /* ---- Layout ---- */
        .container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }

        /* ---- Difficulty Selector ---- */
        .difficulty-bar {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .difficulty-btn {
            padding: 0.35rem 0.7rem;
            font-family: "Source Code Pro", monospace;
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            border: 1px solid var(--border);
            background: var(--muted);
            color: var(--muted-foreground);
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .difficulty-btn.active {
            background: oklch(0.45 0.20 27);
            color: #fff;
            border-color: oklch(0.55 0.25 30);
            box-shadow: 0 0 10px oklch(0.5 0.2 27 / 0.5);
        }

        /* ---- Search Panel ---- */
        .search-panel {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            margin: -1rem auto 1.5rem;
            padding: 1.5rem;
            position: relative;
            z-index: 10;
        }
        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.3rem;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 0.5rem 0.6rem;
            border: 1px solid var(--border);
            font-family: "Oxanium", sans-serif;
            font-size: 0.85rem;
            color: var(--foreground);
            background: var(--background);
            transition: border-color 0.15s;
        }
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--ring);
        }
        .btn-search {
            width: 100%;
            padding: 0.7rem 1.5rem;
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            font-family: "Oxanium", sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: opacity 0.15s;
            box-shadow: 0 4px 0 oklch(0.3 0.05 250), 0 8px 16px oklch(0 0 0 / 0.3);
        }
        .btn-search:hover { opacity: 0.85; }
        .btn-search:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-search:active { transform: translateY(2px); box-shadow: 0 2px 0 oklch(0.3 0.05 250), 0 4px 8px oklch(0 0 0 / 0.2); }

        /* ---- Source Chips ---- */
        .sources-bar { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .source-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.7rem;
            font-size: 0.7rem;
            font-weight: 700;
            font-family: "Oxanium", sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            border: 1px solid var(--border);
            background: var(--muted);
            color: var(--muted-foreground);
            cursor: pointer;
            user-select: none;
            transition: all 0.15s;
        }
        .source-chip.active {
            border-color: var(--primary);
            background: var(--primary);
            color: var(--primary-foreground);
        }
        .source-chip .dot { width: 7px; height: 7px; flex-shrink: 0; }
        .dot-craigslist { background: oklch(0.55 0.15 300); }
        .dot-cargurus { background: oklch(0.55 0.15 245); }
        .dot-carscom { background: oklch(0.55 0.2 27); }
        .dot-autotrader { background: oklch(0.65 0.18 60); }

        /* ---- Stats Row ---- */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .stat-card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            text-align: center;
        }
        .stat-card .value { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: inline-block; }
        .stat-card .label {
            font-size: 0.65rem;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-top: 0.15rem;
        }

        /* ---- Toolbar ---- */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .toolbar select {
            padding: 0.35rem 0.6rem;
            border: 1px solid var(--border);
            font-family: "Oxanium", sans-serif;
            font-size: 0.75rem;
            background: var(--card);
            color: var(--card-foreground);
        }

        /* ---- Vehicle Grid ---- */
        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .vehicle-card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
        }
        .vehicle-card:hover {
            transform: translateY(-4px) scale(1.02);
            animation: fireBorder 800ms ease-in-out infinite;
            border-color: oklch(0.7 0.25 35);
        }
        .card-image {
            width: 100%;
            height: 190px;
            background: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .card-image img { width: 100%; height: 100%; object-fit: cover; }
        .card-image .placeholder-icon { color: var(--muted-foreground); opacity: 0.4; }
        .card-source {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            padding: 0.2rem 0.55rem;
            font-family: "Oxanium", sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-foreground);
        }
        .badge-craigslist { background: oklch(0.45 0.14 300); }
        .badge-cargurus { background: oklch(0.45 0.14 245); }
        .badge-carscom { background: oklch(0.45 0.18 27); }
        .badge-autotrader { background: oklch(0.55 0.16 60); }

        .card-body { padding: 0.9rem; flex: 1; display: flex; flex-direction: column; }
        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }
        .card-meta {
            display: flex;
            gap: 0.8rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
            margin-top: auto;
        }
        .card-meta span { display: flex; align-items: center; gap: 0.2rem; }

        /* ---- Doom Loading ---- */
        .doom-loading { text-align: center; padding: 3rem 1rem; }
        .doom-loading-title {
            font-family: "Oxanium", sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: oklch(0.65 0.25 27);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
            animation: doomPulseText 1s ease-in-out infinite;
            margin-bottom: 1.25rem;
        }
        .doom-bar-outer {
            max-width: 500px;
            margin: 0 auto 1.5rem;
            height: 24px;
            background: oklch(0.15 0 0);
            border: 3px solid oklch(0.40 0 0);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.8), 0 0 15px oklch(0.5 0.25 27 / 0.3);
            position: relative;
            overflow: hidden;
        }
        .doom-bar-fill {
            height: 100%;
            background: linear-gradient(180deg, oklch(0.65 0.25 27) 0%, oklch(0.45 0.22 20) 100%);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 0 10px oklch(0.6 0.25 27 / 0.6);
            animation: doomBarFill 12s linear forwards;
        }
        .doom-platforms {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .doom-platform {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-family: "Source Code Pro", monospace;
            font-size: 0.75rem;
            color: var(--muted-foreground);
            text-transform: uppercase;
        }
        .doom-platform .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: oklch(0.55 0.25 27);
            animation: platformBlink 0.6s ease-in-out infinite;
        }
        .doom-platform .status-dot.done {
            background: oklch(0.65 0.2 130);
            animation: none;
            box-shadow: 0 0 6px oklch(0.65 0.2 130 / 0.8);
        }

        /* ---- Empty / Error ---- */
        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .empty-state .icon { color: var(--muted-foreground); opacity: 0.35; margin-bottom: 0.75rem; }
        .empty-state h3 { font-size: 1rem; margin-bottom: 0.25rem; }
        .empty-state p { font-size: 0.8rem; color: var(--muted-foreground); }

        /* ---- Modal ---- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1100;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 1rem 1rem 80px 1rem;
            overflow-y: auto;
            animation: fadeIn 300ms ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal {
            background: var(--card);
            color: var(--card-foreground);
            border: 2px solid var(--border);
            max-width: 580px;
            width: 100%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            margin-top: auto;
            margin-bottom: auto;
            box-shadow: var(--shadow-xl), 0 0 20px oklch(0.5 0.19 27 / 0.3);
            position: relative;
            animation: pixelateIn 400ms cubic-bezier(0.68, -0.55, 0.27, 1.55), modalGlow 3s ease-in-out infinite;
        }
        @keyframes modalGlow {
            0%, 100% { box-shadow: var(--shadow-xl), 0 0 20px oklch(0.5 0.19 27 / 0.3); }
            50% { box-shadow: var(--shadow-xl), 0 0 40px oklch(0.6 0.22 27 / 0.6), 0 0 80px oklch(0.5 0.19 27 / 0.3), inset 0 0 20px oklch(0.5 0.19 27 / 0.1); }
        }
        .modal-close {
            position: absolute;
            top: 0.6rem;
            right: 0.6rem;
            width: 30px; height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 1rem;
            color: var(--card-foreground);
            z-index: 5;
        }
        .modal-image {
            width: 100%;
            height: 300px;
            background: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .modal-image::before {
            content: '';
            position: absolute;
            inset: -10px;
            background: conic-gradient(from 0deg, oklch(0.5 0.19 27 / 0), oklch(0.6 0.22 27 / 0.3), oklch(0.5 0.19 27 / 0), oklch(0.6 0.22 27 / 0.3), oklch(0.5 0.19 27 / 0));
            animation: portalSpin 6s linear infinite;
            pointer-events: none;
            z-index: 1;
        }
        .modal-image::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 50%, oklch(0 0 0 / 0.4) 100%);
            pointer-events: none;
            z-index: 2;
        }
        @keyframes portalSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .modal-image img { width: 100%; height: 100%; object-fit: cover; }
        .modal-image .placeholder-icon { color: var(--muted-foreground); opacity: 0.3; }
        .modal-image .img-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px; height: 30px;
            background: var(--card);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card-foreground);
        }
        .modal-image .img-nav.prev { left: 0.5rem; }
        .modal-image .img-nav.next { right: 0.5rem; }
        .modal-image .img-counter {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(0,0,0,0.65);
            color: #fff;
            font-family: "Source Code Pro", monospace;
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
        }
        .modal-body { padding: 1.25rem; overflow-y: auto; flex: 1; }
        .modal-body .source-tag {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.6rem;
            font-weight: 700;
            font-family: "Oxanium", sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-foreground);
            margin-bottom: 0.4rem;
        }
        .modal-body h2 { font-size: 1.15rem; font-weight: 700; margin-bottom: 0.4rem; }
        .modal-body .price { font-size: 1.6rem; font-weight: 800; color: var(--secondary); margin-bottom: 0.75rem; }
        .modal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .detail-item {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 0.6rem;
        }
        .detail-item .dl {
            font-size: 0.6rem;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 600;
        }
        .detail-item .dv { font-size: 0.9rem; font-weight: 600; margin-top: 0.1rem; }
        .modal-desc {
            font-size: 0.8rem;
            color: var(--muted-foreground);
            line-height: 1.8;
            margin-bottom: 0.5rem;
            white-space: pre-line;
            border: 1px solid var(--border);
            padding: 0.75rem;
            background: var(--background);
            word-wrap: break-word;
            overflow-wrap: break-word;
            transition: max-height 0.3s ease;
        }
        .modal-desc.collapsed {
            max-height: 150px;
            overflow: hidden;
            position: relative;
        }
        .modal-desc.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 50px;
            background: linear-gradient(to bottom, transparent, var(--background));
            pointer-events: none;
        }
        .desc-toggle {
            display: block;
            width: 100%;
            padding: 0.4rem;
            background: var(--muted);
            color: var(--muted-foreground);
            border: 1px solid var(--border);
            font-family: "Oxanium", sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.15s;
        }
        .desc-toggle:hover { opacity: 0.8; background: var(--primary); color: var(--primary-foreground); }
        .btn-listing {
            display: block;
            width: 100%;
            padding: 0.7rem;
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            font-family: "Oxanium", sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: opacity 0.15s;
        }
        .btn-listing:hover { opacity: 0.85; }

        .detail-loading {
            text-align: center;
            padding: 0.6rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        /* ---- Achievement Toasts ---- */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 0;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            pointer-events: none;
        }
        .achievement-toast {
            background: linear-gradient(135deg, #1a0000 0%, #2d0a0a 50%, #1a0000 100%);
            border: 3px solid #ff4400;
            border-right: none;
            box-shadow: 0 0 20px rgba(255, 68, 0, 0.6), 0 0 40px rgba(255, 68, 0, 0.3), inset 0 0 60px rgba(255, 0, 0, 0.1);
            min-width: 320px;
            padding: 1rem 1.25rem;
            position: relative;
            overflow: hidden;
            pointer-events: auto;
            transform: translateX(400px);
            animation: toastSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        .achievement-toast.exiting { animation: toastSlideOut 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        @keyframes toastSlideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .achievement-toast::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #ffaa00 20%, #ff4400 50%, #ffaa00 80%, transparent 100%);
            animation: toastScanline 2s linear infinite;
        }
        @keyframes toastScanline { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
        .achievement-toast::after {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(0deg, rgba(255, 68, 0, 0.03) 0px, transparent 1px, transparent 2px, rgba(255, 68, 0, 0.03) 3px);
            pointer-events: none;
        }
        .toast-title {
            font-family: "Oxanium", sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #ffaa00;
            text-shadow: 0 0 10px #ff4400, 0 0 20px #ff4400, 0 0 30px #ff0000, 2px 2px 0 #000;
            margin-bottom: 0.3rem;
            position: relative;
            z-index: 1;
            animation: textGlow 1.5s ease-in-out infinite alternate;
        }
        @keyframes textGlow {
            from { text-shadow: 0 0 10px #ff4400, 0 0 20px #ff4400, 0 0 30px #ff0000, 2px 2px 0 #000; }
            to { text-shadow: 0 0 15px #ff6600, 0 0 30px #ff4400, 0 0 45px #ff2200, 2px 2px 0 #000; }
        }
        .toast-subtitle {
            font-family: "Oxanium", sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #cc3300;
            text-shadow: 1px 1px 0 #000;
            position: relative;
            z-index: 1;
        }

        /* ---- Doom HUD ---- */
        .doom-hud {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 70px;
            background: linear-gradient(180deg, oklch(0.35 0 0) 0%, oklch(0.25 0 0) 50%, oklch(0.20 0 0) 100%);
            border-top: 4px solid oklch(0.45 0 0);
            box-shadow: inset 0 3px 0 oklch(0.45 0 0), inset 0 -2px 0 oklch(0.15 0 0), 0 -8px 20px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            font-family: "Oxanium", monospace;
            z-index: 1000;
            user-select: none;
        }
        .doom-hud-section { display: flex; flex-direction: column; gap: 0.15rem; }
        .doom-stat { display: flex; align-items: baseline; gap: 0.5rem; }
        .doom-label {
            font-size: 0.65rem;
            font-weight: 800;
            color: oklch(0.55 0 0);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 1px 1px 0 oklch(0.15 0 0);
        }
        .doom-value {
            font-size: 1.5rem;
            font-weight: 800;
            font-family: "Source Code Pro", monospace;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.8);
            letter-spacing: 0.05em;
        }
        .doom-value.frags { color: oklch(0.75 0.15 60); }
        .doom-value.health { color: oklch(0.65 0.25 27); }
        .doom-value.armor { color: oklch(0.70 0.20 130); }
        .doom-value.ammo { color: oklch(0.75 0.15 245); }
        .doom-face {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, oklch(0.30 0 0) 0%, oklch(0.22 0 0) 100%);
            border: 3px solid oklch(0.15 0 0);
            box-shadow: inset 2px 2px 0 oklch(0.40 0 0), inset -2px -2px 0 oklch(0.18 0 0), 0 4px 8px rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: "Source Code Pro", monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: oklch(0.80 0.15 60);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.9);
            transition: all 0.2s;
        }
        .doom-face.searching { color: oklch(0.75 0.15 245); animation: doomPulseText 0.8s infinite; }
        .doom-face.results { color: oklch(0.75 0.20 130); }
        .doom-face.error { color: oklch(0.70 0.25 27); }
        .doom-health-bar {
            width: 80px; height: 6px;
            background: oklch(0.15 0 0);
            border: 1px solid oklch(0.40 0 0);
            margin-top: 0.2rem;
            overflow: hidden;
        }
        .doom-health-fill {
            height: 100%;
            background: linear-gradient(90deg, oklch(0.65 0.25 27) 0%, oklch(0.75 0.20 50) 100%);
            transition: width 0.3s;
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.3);
        }
        .doom-health-fill.critical { background: linear-gradient(90deg, oklch(0.55 0.25 0) 0%, oklch(0.60 0.25 27) 100%); }

        /* ---- Footer ---- */
        .footer {
            text-align: center;
            padding: 2rem 1rem;
            font-size: 0.7rem;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        /* ---- Responsive ---- */
        @media (min-width: 641px) and (max-width: 1024px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            .search-form-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }
        @media (max-width: 640px) {
            .header h1 { font-size: 1.25rem; }
            .header-inner { flex-direction: row; }
            .search-grid { grid-template-columns: 1fr 1fr; }
            .vehicle-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .modal-details { grid-template-columns: 1fr; }
            .difficulty-bar { gap: 0.25rem; }
            .difficulty-btn { font-size: 0.55rem; padding: 0.25rem 0.5rem; }
            .doom-hud { height: 60px; padding: 0 0.75rem; }
            .doom-hud-section:nth-child(3),
            .doom-hud-section:nth-child(4) { display: none; }
            .doom-value { font-size: 1.2rem; }
            .doom-label { font-size: 0.7rem; }
            .doom-face { width: 50px; height: 50px; font-size: 1.3rem; }
            .toast-container { top: 60px; left: 0; padding: 0.5rem; }
            .achievement-toast { min-width: unset; width: 100%; border-right: 3px solid #ff4400; }
            .toast-title { font-size: 1.1rem; }
            .toast-subtitle { font-size: 0.75rem; }
        }
        /* ---- AI Chat Drawer ---- */
        .chat-fab { position: fixed; bottom: 80px; right: 1.25rem; width: 52px; height: 52px; background: linear-gradient(135deg, oklch(0.55 0.22 27), oklch(0.40 0.18 20)); border: 2px solid oklch(0.65 0.25 35); border-radius: 50%; box-shadow: 0 0 18px oklch(0.5 0.2 27 / 0.5), 0 4px 12px rgba(0,0,0,0.4); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1050; transition: transform 0.2s, box-shadow 0.2s; }
        .chat-fab:hover { transform: scale(1.1); box-shadow: 0 0 28px oklch(0.6 0.25 27 / 0.7); }
        .chat-drawer { position: fixed; top: 0; right: 0; bottom: 0; width: 420px; max-width: 100vw; background: var(--card); border-left: 2px solid var(--border); box-shadow: -8px 0 30px rgba(0,0,0,0.5); z-index: 1200; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-drawer.open { transform: translateX(0); }
        .chat-header { padding: 1rem 1.25rem; background: linear-gradient(135deg, oklch(0.30 0.08 27), oklch(0.22 0.04 20)); border-bottom: 2px solid oklch(0.45 0.15 27); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .chat-header h3 { font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: oklch(0.75 0.18 40); text-shadow: 0 0 10px oklch(0.6 0.2 27 / 0.5); }
        .chat-close-btn { background: none; border: 1px solid oklch(0.45 0 0); color: var(--card-foreground); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1rem; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-msg { max-width: 88%; padding: 0.7rem 0.9rem; font-size: 0.82rem; line-height: 1.6; border: 1px solid var(--border); word-wrap: break-word; }
        .chat-msg.user { align-self: flex-end; background: oklch(0.35 0.10 27); color: oklch(0.9 0 0); border-color: oklch(0.45 0.12 27); }
        .chat-msg.ai { align-self: flex-start; background: var(--background); color: var(--foreground); }
        .chat-msg .ai-icon { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: oklch(0.65 0.18 27); margin-right: 0.3rem; }
        .chat-typing { font-size: 0.75rem; color: var(--muted-foreground); font-family: "Source Code Pro", monospace; animation: doomPulseText 0.8s infinite; }
        .chat-input-area { padding: 0.75rem 1rem; border-top: 1px solid var(--border); flex-shrink: 0; }
        .chat-chips { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .chat-chip { padding: 0.25rem 0.5rem; font-family: "Oxanium", sans-serif; font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; border: 1px solid var(--border); background: var(--muted); color: var(--muted-foreground); cursor: pointer; transition: all 0.15s; }
        .chat-chip:hover { background: var(--primary); color: var(--primary-foreground); border-color: var(--primary); }
        .chat-input-row { display: flex; gap: 0.5rem; }
        .chat-input { flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border); font-family: "Oxanium", sans-serif; font-size: 0.85rem; background: var(--background); color: var(--foreground); }
        .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--ring); }
        .chat-send { padding: 0.5rem 1rem; background: var(--primary); color: var(--primary-foreground); border: none; font-family: "Oxanium", sans-serif; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .chat-send:hover { opacity: 0.85; }
        .chat-send:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ---- Modal Tabs ---- */
        .modal-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 1rem; }
        .modal-tab { padding: 0.5rem 1rem; font-family: "Oxanium", sans-serif; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; background: none; border: none; color: var(--muted-foreground); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
        .modal-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .modal-tab:hover { color: var(--foreground); }

        /* ---- AI Intel ---- */
        .ai-intel { padding: 0.5rem 0; }
        .ai-scanning { text-align: center; padding: 2rem 0; }
        .ai-scanning-text { font-family: "Source Code Pro", monospace; font-size: 0.85rem; color: oklch(0.65 0.25 27); animation: doomPulseText 1.2s ease-in-out infinite; text-transform: uppercase; letter-spacing: 0.1em; }
        .ai-summary { background: var(--background); border: 1px solid var(--border); padding: 0.75rem; margin-bottom: 0.75rem; font-size: 0.8rem; line-height: 1.6; }
        .ai-pros-cons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem; }
        .ai-list { list-style: none; padding: 0; }
        .ai-list li { font-size: 0.75rem; padding: 0.25rem 0 0.25rem 1rem; position: relative; }
        .ai-list li::before { content: ''; position: absolute; left: 0; top: 0.55rem; width: 6px; height: 6px; border-radius: 50%; }
        .ai-list.pros li::before { background: #16a34a; box-shadow: 0 0 4px #16a34a; }
        .ai-list.cons li::before { background: #ea580c; box-shadow: 0 0 4px #ea580c; }
        .ai-list-title { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted-foreground); margin-bottom: 0.4rem; }
        .reliability-bar { height: 8px; background: var(--muted); border: 1px solid var(--border); overflow: hidden; margin-top: 0.3rem; }
        .reliability-fill { height: 100%; transition: width 0.5s; }
        .price-verdict { display: inline-block; padding: 0.2rem 0.6rem; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.04em; color: #fff; margin-bottom: 0.75rem; }
        .deal-great { background: oklch(0.55 0.2 145); box-shadow: 0 0 8px oklch(0.55 0.2 145 / 0.4); }
        .deal-good { background: oklch(0.55 0.15 240); }
        .deal-fair { background: oklch(0.45 0 0); }
        .deal-above { background: oklch(0.6 0.18 60); color: #000; }
        .deal-over { background: oklch(0.55 0.22 27); }
        .ai-issues { margin-bottom: 0.75rem; }
        .ai-issues summary { font-size: 0.75rem; font-weight: 700; cursor: pointer; color: var(--muted-foreground); text-transform: uppercase; }
        .ai-issues ul { list-style: disc; padding-left: 1.2rem; margin-top: 0.4rem; }
        .ai-issues li { font-size: 0.75rem; color: var(--muted-foreground); margin-bottom: 0.2rem; }

        /* ---- Safety Intel ---- */
        .safety-intel { padding: 0.5rem 0; }
        .safety-stars { display: flex; gap: 0.2rem; margin: 0.3rem 0 0.5rem; }
        .safety-star { width: 20px; height: 20px; }
        .safety-stat { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
        .safety-stat .s-label { color: var(--muted-foreground); text-transform: uppercase; font-size: 0.7rem; }
        .safety-stat .s-val { font-weight: 700; }

        @media (max-width: 640px) {
            .chat-drawer { width: 100vw; }
            .ai-pros-cons { grid-template-columns: 1fr; }
            .chat-fab { bottom: 70px; right: 0.75rem; width: 44px; height: 44px; }
        }

        /* ---- Chat Error Messages ---- */
        .chat-msg.error { border-color: oklch(0.55 0.22 27); background: oklch(0.25 0.06 27); }
        .chat-msg.error .ai-icon { color: oklch(0.7 0.25 27); }

        /* ---- Research Links ---- */
        .research-link { display:block; font-size:0.72rem; color:var(--primary); text-decoration:none; padding:0.2rem 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .research-link:hover { text-decoration:underline; opacity:0.85; }

        /* ---- Deal Badge on Cards ---- */
        .deal-badge { flex-shrink:0; padding:0.15rem 0.4rem; font-size:0.55rem; font-weight:800; text-transform:uppercase; letter-spacing:0.04em; color:#fff; white-space:nowrap; }
        .deal-badge-great-deal { background:oklch(0.55 0.2 145); box-shadow:0 0 6px oklch(0.55 0.2 145 / 0.4); }
        .deal-badge-good-deal { background:oklch(0.55 0.15 240); }
        .deal-badge-fair { background:oklch(0.45 0 0); }
        .deal-badge-above-market { background:oklch(0.6 0.18 60); color:#000; }
        .deal-badge-overpriced { background:oklch(0.55 0.22 27); }

        /* ---- Deal Badge Shimmer ---- */
        @keyframes shimmer {
            0% { background-position: -100px 0; }
            100% { background-position: 100px 0; }
        }
        .deal-badge-shimmer {
            flex-shrink:0;
            width:52px; height:16px;
            background: linear-gradient(90deg, var(--muted) 25%, oklch(0.6 0 0 / 0.3) 50%, var(--muted) 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>
<body x-data="app()" :class="{ dark: darkMode, shaking: isShaking }">

    <!-- CRT Scanlines -->
    <div class="scanlines"></div>

    <!-- Red Flash Overlay -->
    <div class="red-flash-overlay" :class="{ active: redFlash }"></div>

    <!-- 3D Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- 3D Weapon Effects Canvas -->
    <canvas id="weapon-canvas"></canvas>

    <!-- Header -->
    <div class="header">
        <div class="header-inner">
            <div class="header-text">
                <h1 class="glitch-text" data-text="Milwaukee Vehicle Finder">Milwaukee Vehicle Finder</h1>
                <p>Search used cars across Craigslist, CarGurus, Cars.com &amp; AutoTrader</p>
            </div>
            <div class="header-buttons">
                <button class="sound-toggle" @click="toggleSound()" :title="soundEnabled ? 'Mute sounds' : 'Enable sounds'" aria-label="Toggle sound">
                    <svg x-show="soundEnabled" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    <svg x-show="!soundEnabled" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
                </button>
                <button class="theme-toggle" @click="toggleDark()" :title="darkMode ? 'Light mode' : 'Dark mode'" aria-label="Toggle theme">
                    <svg x-show="!darkMode" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    <svg x-show="darkMode" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- Search Panel -->
        <div class="search-panel">
            <!-- Difficulty Selector -->
            <div class="difficulty-bar">
                <button class="difficulty-btn" :class="{ active: selectedDifficulty === 'easy' }"
                        @click="setDifficulty('easy', '50000')">
                    &gt;&gt; I'm Too Young To Die &lt;&lt;
                </button>
                <button class="difficulty-btn" :class="{ active: selectedDifficulty === 'medium' }"
                        @click="setDifficulty('medium', '20000')">
                    &gt;&gt; Hurt Me Plenty &lt;&lt;
                </button>
                <button class="difficulty-btn" :class="{ active: selectedDifficulty === 'hard' }"
                        @click="setDifficulty('hard', '10000')">
                    &gt;&gt; Ultra-Violence &lt;&lt;
                </button>
                <button class="difficulty-btn" :class="{ active: selectedDifficulty === 'nightmare' }"
                        @click="setDifficulty('nightmare', '5000')">
                    &gt;&gt; Nightmare! &lt;&lt;
                </button>
            </div>

            <div class="search-grid">
                <div class="form-group">
                    <label>Make</label>
                    <select x-model="params.make" @change="onMakeChange()">
                        <option value="">Any Make</option>
                        <template x-for="m in makes" :key="m">
                            <option :value="m" x-text="m"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Model</label>
                    <select x-model="params.model">
                        <option value="">Any Model</option>
                        <template x-for="m in availableModels" :key="m">
                            <option :value="m" x-text="m"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Min Year</label>
                    <select x-model="params.min_year">
                        <option value="">Any</option>
                        <template x-for="y in years" :key="'min'+y">
                            <option :value="y" x-text="y"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Year</label>
                    <select x-model="params.max_year">
                        <option value="">Any</option>
                        <template x-for="y in years" :key="'max'+y">
                            <option :value="y" x-text="y"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Price</label>
                    <select x-model="params.max_price">
                        <option value="5000">$5,000</option>
                        <option value="10000">$10,000</option>
                        <option value="15000">$15,000</option>
                        <option value="20000" selected>$20,000</option>
                        <option value="25000">$25,000</option>
                        <option value="30000">$30,000</option>
                        <option value="40000">$40,000</option>
                        <option value="50000">$50,000</option>
                        <option value="100000">$100,000</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Mileage</label>
                    <select x-model="params.max_mileage">
                        <option value="25000">25,000 mi</option>
                        <option value="50000">50,000 mi</option>
                        <option value="75000">75,000 mi</option>
                        <option value="100000">100,000 mi</option>
                        <option value="150000" selected>150,000 mi</option>
                        <option value="200000">200,000 mi</option>
                        <option value="999999">Any</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ZIP Code</label>
                    <input type="text" x-model="params.zip_code" maxlength="5" placeholder="53202">
                </div>
            </div>
            <button class="btn-search" @click="search()" :disabled="loading">
                <span x-show="!loading">Rip and Tear</span>
                <span x-show="loading">Ripping...</span>
            </button>
            <button @click="saveCurrentSearch()" style="padding:0.5rem 0.8rem;background:var(--secondary);color:var(--secondary-foreground);border:none;border-radius:4px;cursor:pointer;font-size:0.75rem;font-family:inherit;margin-left:0.5rem;" title="Save this search">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:0.3rem;"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>Save
            </button>
            <div x-show="savedSearches.length > 0" style="margin-top:0.5rem;">
                <button @click="showSavedSearches = !showSavedSearches" style="font-size:0.75rem;background:none;border:none;color:var(--muted-foreground);cursor:pointer;text-decoration:underline;font-family:inherit;">
                    Saved Searches (<span x-text="savedSearches.length"></span>)
                </button>
                <div x-show="showSavedSearches" x-transition style="margin-top:0.5rem;display:flex;flex-wrap:wrap;gap:0.4rem;">
                    <template x-for="s in savedSearches" :key="s.id">
                        <div style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.25rem 0.6rem;background:var(--muted);border-radius:4px;font-size:0.75rem;">
                            <span @click="loadSavedSearch(s)" style="cursor:pointer;" x-text="s.label"></span>
                            <button @click="deleteSavedSearch(s.id)" style="background:none;border:none;color:var(--muted-foreground);cursor:pointer;font-size:0.9rem;padding:0;line-height:1;">&times;</button>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Doom Loading -->
        <div x-show="loading" class="doom-loading">
            <div class="doom-loading-title">Searching the wasteland...</div>
            <div class="doom-bar-outer">
                <div class="doom-bar-fill" :key="loadingKey"></div>
            </div>
            <div class="doom-platforms">
                <div class="doom-platform">
                    <div class="status-dot" :class="{ done: loadingComplete.craigslist }"></div>
                    Craigslist
                </div>
                <div class="doom-platform">
                    <div class="status-dot" :class="{ done: loadingComplete.cargurus }"></div>
                    CarGurus
                </div>
                <div class="doom-platform">
                    <div class="status-dot" :class="{ done: loadingComplete.carscom }"></div>
                    Cars.com
                </div>
                <div class="doom-platform">
                    <div class="status-dot" :class="{ done: loadingComplete.autotrader }"></div>
                    AutoTrader
                </div>
            </div>
        </div>

        <!-- Results -->
        <div x-show="!loading && searched">

            <!-- Stats -->
            <div class="stats-row" x-show="allResults.length > 0">
                <div class="stat-card">
                    <div class="value" :class="{ 'stat-pop': statPop }" x-text="filtered.length"></div>
                    <div class="label">Vehicles Found</div>
                </div>
                <div class="stat-card">
                    <div class="value" :class="{ 'stat-pop': statPop }" x-text="'$' + avgPrice.toLocaleString()"></div>
                    <div class="label">Avg Price</div>
                </div>
                <div class="stat-card">
                    <div class="value" :class="{ 'stat-pop': statPop }" x-text="bestDeal ? ('$' + bestDeal.toLocaleString()) : '-'"></div>
                    <div class="label">Lowest Price</div>
                </div>
                <div class="stat-card">
                    <div class="value" :class="{ 'stat-pop': statPop }" x-text="sourcesWithResults + '/' + sourcesTotal"></div>
                    <div class="label">Sources</div>
                </div>
            </div>

            <!-- AI Market Summary -->
            <div x-show="marketSummary || marketLoading" class="market-summary" style="margin-bottom:1rem;">
                <div class="market-header" @click="marketExpanded = !marketExpanded" style="display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; background:linear-gradient(135deg, oklch(0.30 0.08 27), oklch(0.22 0.04 20)); border:1px solid oklch(0.45 0.15 27); cursor:pointer; user-select:none;">
                    <span style="font-size:0.75rem; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; color:oklch(0.75 0.18 40); text-shadow:0 0 10px oklch(0.6 0.2 27 / 0.5);">AI Market Intel</span>
                    <span style="color:oklch(0.65 0 0); font-size:0.8rem;" x-text="marketExpanded ? '[-]' : '[+]'"></span>
                </div>
                <div x-show="marketExpanded" style="background:var(--card); border:1px solid var(--border); border-top:none; padding:1rem;">
                    <div x-show="marketLoading" style="text-align:center; padding:1rem;">
                        <div class="ai-scanning-text" style="font-size:0.75rem;">Analyzing market data...</div>
                    </div>
                    <div x-show="!marketLoading && marketSummary">
                        <div x-show="marketSummary && marketSummary.summary" style="font-size:0.82rem; line-height:1.7; margin-bottom:0.75rem; color:var(--foreground);" x-html="renderMarkdown(marketSummary ? marketSummary.summary : '')"></div>
                        <div x-show="marketSummary && marketSummary.best_deals && marketSummary.best_deals.length > 0" style="margin-bottom:0.75rem;">
                            <div class="ai-list-title" style="color:oklch(0.65 0.2 130);">Best Deals</div>
                            <ul class="ai-list pros">
                                <template x-for="d in (marketSummary ? marketSummary.best_deals || [] : [])" :key="d.title"><li><strong x-text="d.title"></strong> <span style="color:var(--muted-foreground);" x-text="' ' + d.reason"></span></li></template>
                            </ul>
                        </div>
                        <div x-show="marketSummary && marketSummary.overpriced && marketSummary.overpriced.length > 0" style="margin-bottom:0.75rem;">
                            <div class="ai-list-title" style="color:oklch(0.65 0.25 27);">Overpriced Warnings</div>
                            <ul class="ai-list cons">
                                <template x-for="o in (marketSummary ? marketSummary.overpriced || [] : [])" :key="o.title"><li><strong x-text="o.title"></strong> <span style="color:var(--muted-foreground);" x-text="' ' + o.reason"></span></li></template>
                            </ul>
                        </div>
                        <div x-show="marketSummary && marketSummary.recommendations" style="font-size:0.8rem; line-height:1.6; color:var(--muted-foreground);" x-html="renderMarkdown(marketSummary ? marketSummary.recommendations : '')"></div>
                    </div>
                </div>
            </div>

            <!-- Source Chips + Sort -->
            <div class="toolbar" x-show="allResults.length > 0">
                <div class="sources-bar">
                    <div class="source-chip" :class="{ active: activeSource === 'all' }" @click="activeSource = 'all'">
                        All
                        <span style="opacity:0.7" x-text="'(' + allResults.length + ')'"></span>
                    </div>
                    <template x-for="s in sourceInfo" :key="s.name">
                        <div class="source-chip"
                             :class="{ active: activeSource === s.name }"
                             @click="activeSource = s.name">
                            <span class="dot" :class="'dot-' + s.key"></span>
                            <span x-text="s.name"></span>
                            <span style="opacity:0.7" x-text="'(' + s.count + ')'"></span>
                        </div>
                    </template>
                </div>
                <div>
                    <select x-model="sortBy" @change="applySort()">
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="mileage-asc">Mileage: Low to High</option>
                        <option value="mileage-desc">Mileage: High to Low</option>
                        <option value="year-desc">Year: Newest First</option>
                        <option value="year-asc">Year: Oldest First</option>
                    </select>
                </div>
            </div>

            <!-- Grid -->
            <div class="vehicle-grid" x-show="filtered.length > 0">
                <template x-for="(v, idx) in filtered" :key="v.id">
                    <div class="vehicle-card slam-enter" :style="'--i:' + idx" @click="fireWeaponAndOpen($event, v)">
                        <div class="card-image">
                            <template x-if="v.image_url">
                                <img :src="v.image_url" :alt="v.title" loading="lazy"
                                     @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex'">
                            </template>
                            <div class="placeholder-icon" :style="v.image_url ? 'display:none' : ''">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M7 17a2 2 0 1 0 4 0 2 2 0 0 0-4 0Zm10 0a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"/>
                                    <path d="M5 17H3v-5l2-5h9l4 5h3v5h-2"/><path d="M5 12h14"/>
                                </svg>
                            </div>
                            <span class="card-source" :class="'badge-' + sourceKey(v.source)" x-text="v.source"></span>
                            <button @click.stop="toggleFavorite(v)" :title="isFavorite(v.id) ? 'Remove from favorites' : 'Add to favorites'" style="position:absolute;top:0.5rem;right:0.5rem;background:rgba(0,0,0,0.5);border:none;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:2;">
                                <svg width="16" height="16" viewBox="0 0 24 24" :fill="isFavorite(v.id) ? '#ff4444' : 'none'" stroke="#ff4444" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            </button>
                        </div>
                        <div class="card-body">
                            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:0.4rem;">
                                <div class="card-title" x-text="v.title"></div>
                                <span x-show="dealBadges[v.id]" class="deal-badge" :class="'deal-badge-' + (dealBadges[v.id] || '').toLowerCase().replace(/\s+/g, '-')" x-text="dealBadges[v.id]"></span>
                                <span x-show="!dealBadges[v.id] && idx < 6" class="deal-badge-shimmer"></span>
                            </div>
                            <div class="card-price" x-text="'$' + v.price.toLocaleString()"></div>
                            <div class="card-meta">
                                <span x-show="v.year">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    <span x-text="v.year"></span>
                                </span>
                                <span x-show="v.mileage">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <span x-text="v.mileage ? v.mileage.toLocaleString() + ' mi' : ''"></span>
                                </span>
                                <span x-show="v.location">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <span x-text="v.location"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div class="empty-state" x-show="allResults.length === 0 && !error">
                <div class="icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </div>
                <h3>No vehicles found</h3>
                <p>Try broadening your search criteria &mdash; increase max price, mileage, or year range.</p>
            </div>

            <!-- Filtered to 0 -->
            <div class="empty-state" x-show="allResults.length > 0 && filtered.length === 0">
                <div class="icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                </div>
                <h3>No results for this filter</h3>
                <p>Try selecting a different source.</p>
            </div>

            <!-- Error -->
            <div class="empty-state" x-show="error" style="border-left: 3px solid var(--destructive);">
                <h3 style="color: var(--destructive);">Search Error</h3>
                <p x-text="error"></p>
            </div>
        </div>
    </div>

    <div class="footer">Milwaukee Vehicle Finder &middot; Results scraped in real-time from public listings</div>

    <!-- Achievement Toast Container -->
    <div class="toast-container">
        <template x-for="(toast, index) in toasts" :key="toast.id">
            <div class="achievement-toast" :class="{ 'exiting': toast.exiting }">
                <div class="toast-title" x-text="toast.title"></div>
                <div class="toast-subtitle" x-text="toast.subtitle"></div>
            </div>
        </template>
    </div>

    <!-- Doom HUD -->
    <div class="doom-hud">
        <div class="doom-hud-section">
            <div class="doom-stat">
                <span class="doom-label">Frags</span>
                <span class="doom-value frags" x-text="allResults.length"></span>
            </div>
        </div>
        <div class="doom-hud-section">
            <div class="doom-stat">
                <span class="doom-label">Health</span>
                <span class="doom-value health" x-text="searchHealth + '%'"></span>
            </div>
            <div class="doom-health-bar">
                <div class="doom-health-fill"
                     :class="{ critical: searchHealth < 50 }"
                     :style="'width: ' + searchHealth + '%'"></div>
            </div>
        </div>
        <div class="doom-face" :class="hudState" x-text="hudFace"></div>
        <div class="doom-hud-section">
            <div class="doom-stat">
                <span class="doom-label">Armor</span>
                <span class="doom-value armor" x-text="avgPrice > 0 ? ('$' + (avgPrice / 1000).toFixed(1) + 'K') : '$0'"></span>
            </div>
        </div>
        <div class="doom-hud-section">
            <div class="doom-stat">
                <span class="doom-label">Ammo</span>
                <span class="doom-value ammo" x-text="searchCount"></span>
            </div>
        </div>
    </div>

    <!-- Chat FAB -->
    <button class="chat-fab" @click="chatOpen = !chatOpen" title="AI Advisor" aria-label="Open AI chat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </button>

    <!-- Chat Drawer -->
    <div class="chat-drawer" :class="{ open: chatOpen }">
        <div class="chat-header">
            <h3>AI Advisor</h3>
            <button class="chat-close-btn" @click="chatOpen = false" aria-label="Close chat">&times;</button>
        </div>
        <div class="chat-messages" x-ref="chatMessages">
            <template x-for="(msg, i) in chatMessages" :key="i">
                <div class="chat-msg" :class="[msg.role, msg.isError ? 'error' : '']">
                    <template x-if="msg.role === 'ai'"><span class="ai-icon" x-text="msg.isError ? '!!' : 'AI'"></span></template>
                    <span x-html="msg.role === 'ai' ? renderMarkdown(msg.text) : msg.text"></span>
                </div>
            </template>
            <div class="chat-msg ai" x-show="chatTyping"><span class="ai-icon">AI</span> <span class="chat-typing">PROCESSING...</span></div>
        </div>
        <div class="chat-input-area">
            <div class="chat-chips">
                <template x-for="chip in chatChips" :key="chip">
                    <button class="chat-chip" @click="sendChat(chip)" x-text="chip"></button>
                </template>
            </div>
            <div class="chat-input-row">
                <input class="chat-input" type="text" x-model="chatInput" @keydown.enter="sendChat(chatInput)" placeholder="Ask about vehicles...">
                <button class="chat-send" @click="sendChat(chatInput)" :disabled="chatTyping || !chatInput.trim()">Send</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <template x-if="selected">
        <div class="modal-backdrop" @click.self="closeModal()" @keydown.escape.window="closeModal()">
            <div class="modal" @click.stop role="dialog" aria-modal="true" aria-labelledby="modal-title">
                <button class="modal-close" @click="closeModal()" aria-label="Close modal">&times;</button>

                <div class="modal-image">
                    <template x-if="modalImages.length > 0">
                        <img :src="modalImages[modalImgIdx]" :alt="selected.title"
                             @error="$event.target.style.display='none'">
                    </template>
                    <div class="placeholder-icon" x-show="modalImages.length === 0 && !detailLoading">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M7 17a2 2 0 1 0 4 0 2 2 0 0 0-4 0Zm10 0a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"/>
                            <path d="M5 17H3v-5l2-5h9l4 5h3v5h-2"/><path d="M5 12h14"/>
                        </svg>
                    </div>
                    <div class="loading-spinner" x-show="modalImages.length === 0 && detailLoading" style="position:absolute; width:36px; height:36px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.6s linear infinite;"></div>
                    <template x-if="modalImages.length > 1">
                        <button class="img-nav prev" @click.stop="modalImgIdx = (modalImgIdx - 1 + modalImages.length) % modalImages.length">&lsaquo;</button>
                    </template>
                    <template x-if="modalImages.length > 1">
                        <button class="img-nav next" @click.stop="modalImgIdx = (modalImgIdx + 1) % modalImages.length">&rsaquo;</button>
                    </template>
                    <template x-if="modalImages.length > 1">
                        <div class="img-counter" x-text="(modalImgIdx + 1) + ' / ' + modalImages.length"></div>
                    </template>
                </div>

                <div class="modal-body">
                    <span class="source-tag" :class="'badge-' + sourceKey(selected.source)" x-text="selected.source"></span>
                    <h2 id="modal-title" x-text="selected.title"></h2>
                    <div class="price" x-text="'$' + selected.price.toLocaleString()"></div>
                    <button class="ask-car-btn" @click="chatOpen = true; sendChat('Tell me about this ' + selected.title + ' listed at $' + selected.price.toLocaleString())" style="display:inline-flex;align-items:center;gap:0.4rem;margin:0.5rem 0;padding:0.4rem 0.8rem;background:var(--primary);color:var(--primary-foreground);border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;font-family:inherit;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        Ask AI about this car
                    </button>
                    <button @click="shareListing(selected)" style="display:inline-flex;align-items:center;gap:0.4rem;margin:0.5rem 0 0.5rem 0.5rem;padding:0.4rem 0.8rem;background:var(--muted);color:var(--foreground);border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;font-family:inherit;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                        Share
                    </button>

                    <!-- Modal Tabs -->
                    <div class="modal-tabs">
                        <button class="modal-tab" :class="{ active: modalTab === 'details' }" @click="modalTab = 'details'">Details</button>
                        <button class="modal-tab" :class="{ active: modalTab === 'report' }" @click="modalTab = 'report'">AI Report</button>
                    </div>

                    <!-- Details Tab -->
                    <div x-show="modalTab === 'details'">
                        <div class="modal-details">
                            <div class="detail-item" x-show="selected.year">
                                <div class="dl">Year</div>
                                <div class="dv" x-text="selected.year"></div>
                            </div>
                            <div class="detail-item" x-show="selected.mileage">
                                <div class="dl">Mileage</div>
                                <div class="dv" x-text="selected.mileage ? selected.mileage.toLocaleString() + ' mi' : '-'"></div>
                            </div>
                            <div class="detail-item" x-show="selected.location">
                                <div class="dl">Location</div>
                                <div class="dv" x-text="selected.location"></div>
                            </div>
                            <div class="detail-item" x-show="selected.source">
                                <div class="dl">Source</div>
                                <div class="dv" x-text="selected.source"></div>
                            </div>
                            <template x-for="(val, key) in extraDetails" :key="key">
                                <div class="detail-item" x-show="val && key !== 'description'">
                                    <div class="dl" x-text="key"></div>
                                    <div class="dv" x-text="val"></div>
                                </div>
                            </template>
                        </div>

                        <div class="detail-loading" x-show="detailLoading">Loading additional details...</div>

                        <div x-show="extraDetails.description">
                            <div class="modal-desc"
                                 :class="{ 'collapsed': descCollapsed && extraDetails.description && extraDetails.description.length > 200 }"
                                 x-html="formatDescription(extraDetails.description)"></div>
                            <button x-show="extraDetails.description && extraDetails.description.length > 200"
                                    class="desc-toggle"
                                    @click="descCollapsed = !descCollapsed"
                                    x-text="descCollapsed ? '[ Show Full Description ]' : '[ Collapse Description ]'"></button>
                        </div>

                        <a class="btn-listing" :href="selected.url" target="_blank" rel="noopener">
                            View Full Listing &rarr;
                        </a>
                    </div>

                    <!-- AI Report Tab (Unified) -->
                    <div x-show="modalTab === 'report'" class="ai-intel">
                        <!-- Loading state -->
                        <div class="ai-scanning" x-show="reviewLoading && safetyLoading">
                            <div class="ai-scanning-text">Scanning Target...</div>
                        </div>

                        <!-- AI Review Section -->
                        <div x-show="!reviewLoading">
                            <div x-show="currentReview">
                                <div class="ai-summary" x-text="currentReview ? currentReview.summary : ''"></div>
                                <template x-if="currentReview && currentReview.price_verdict">
                                    <span class="price-verdict" :class="'deal-' + (currentReview.price_verdict === 'great_deal' ? 'great' : currentReview.price_verdict === 'good_deal' ? 'good' : currentReview.price_verdict === 'fair' ? 'fair' : currentReview.price_verdict === 'above_market' ? 'above' : 'over')" x-text="(currentReview.price_verdict || '').replace(/_/g, ' ')"></span>
                                </template>
                                <div class="ai-pros-cons">
                                    <div>
                                        <div class="ai-list-title">Pros</div>
                                        <ul class="ai-list pros">
                                            <template x-for="p in (currentReview ? currentReview.pros || [] : [])" :key="p"><li x-text="p"></li></template>
                                        </ul>
                                    </div>
                                    <div>
                                        <div class="ai-list-title">Cons</div>
                                        <ul class="ai-list cons">
                                            <template x-for="c in (currentReview ? currentReview.cons || [] : [])" :key="c"><li x-text="c"></li></template>
                                        </ul>
                                    </div>
                                </div>
                                <div x-show="currentReview && currentReview.reliability_rating" style="margin-bottom:0.75rem;">
                                    <div class="ai-list-title">Reliability <span x-text="currentReview ? currentReview.reliability_rating + '/5' : ''"></span></div>
                                    <div class="reliability-bar"><div class="reliability-fill" :style="'width:' + (currentReview ? currentReview.reliability_rating * 20 : 0) + '%; background: linear-gradient(90deg, oklch(0.65 0.25 27), oklch(0.65 0.2 130));'"></div></div>
                                </div>
                                <div x-show="currentReview && currentReview.fair_price_assessment" style="font-size:0.8rem; line-height:1.6; margin-bottom:0.75rem; color:var(--muted-foreground);" x-text="currentReview ? currentReview.fair_price_assessment : ''"></div>
                                <details class="ai-issues" x-show="currentReview && currentReview.known_issues && currentReview.known_issues.length > 0">
                                    <summary>Known Issues</summary>
                                    <ul><template x-for="issue in (currentReview ? currentReview.known_issues || [] : [])" :key="issue"><li x-text="issue"></li></template></ul>
                                </details>
                                <div x-show="currentReview && currentReview.cost_to_own_notes" style="font-size:0.75rem; line-height:1.5; color:var(--muted-foreground); margin-bottom:0.75rem;">
                                    <div class="ai-list-title">Cost to Own</div>
                                    <span x-text="currentReview ? currentReview.cost_to_own_notes : ''"></span>
                                </div>
                                <!-- Research Links -->
                                <div x-show="currentReview && currentReview.sources && currentReview.sources.length > 0" style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid var(--border);">
                                    <h4 style="font-size:0.85rem;margin-bottom:0.5rem;color:var(--muted-foreground);">Research Links</h4>
                                    <div style="display:flex;flex-wrap:wrap;gap:0.4rem;">
                                        <template x-for="src in (currentReview ? currentReview.sources || [] : [])" :key="src.url">
                                            <a :href="src.url" target="_blank" rel="noopener noreferrer"
                                               style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.25rem 0.6rem;background:var(--muted);color:var(--foreground);border-radius:4px;font-size:0.75rem;text-decoration:none;"
                                               x-text="src.name || src.url.split('/')[2]"></a>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div x-show="!currentReview && reviewError" style="text-align:center; padding:1rem; font-size:0.8rem; color:var(--muted-foreground);" x-text="reviewError"></div>
                            <div x-show="reviewLoading && !safetyLoading" class="ai-scanning"><div class="ai-scanning-text">Loading AI Review...</div></div>
                        </div>

                        <!-- Divider -->
                        <div x-show="(currentReview || reviewError) && !safetyLoading" style="border-top:1px solid var(--border); margin:0.75rem 0;"></div>

                        <!-- NHTSA Safety Section -->
                        <div x-show="safetyLoading && !reviewLoading" class="ai-scanning"><div class="ai-scanning-text">Loading Safety Data...</div></div>
                        <div x-show="!safetyLoading">
                            <div x-show="currentSafety">
                                <div class="ai-list-title">NHTSA Safety Rating</div>
                                <div class="safety-stars">
                                    <template x-for="i in 5" :key="'star'+i">
                                        <svg class="safety-star" viewBox="0 0 24 24" :fill="i <= (currentSafety && currentSafety.safety ? parseInt(currentSafety.safety.overall_rating) || 0 : 0) ? '#ffaa00' : 'none'" stroke="#ffaa00" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                    </template>
                                </div>
                                <div class="safety-stat"><span class="s-label">Recalls</span><span class="s-val" x-text="currentSafety ? currentSafety.recall_count : '-'"></span></div>
                                <div class="safety-stat"><span class="s-label">Complaints</span><span class="s-val" x-text="currentSafety ? currentSafety.complaint_count : '-'"></span></div>
                                <template x-if="currentSafety && currentSafety.recalls && currentSafety.recalls.length > 0">
                                    <details class="ai-issues" style="margin-top:0.75rem;">
                                        <summary>Recall Details</summary>
                                        <ul><template x-for="r in currentSafety.recalls" :key="r.summary"><li><strong x-text="r.component"></strong>: <span x-text="r.summary"></span></li></template></ul>
                                    </details>
                                </template>
                                <a x-show="currentSafety && currentSafety.nhtsa_url" :href="currentSafety ? currentSafety.nhtsa_url : '#'" target="_blank" rel="noopener" style="display:inline-block; margin-top:0.5rem; font-size:0.75rem; color:var(--primary);">View on NHTSA.gov</a>
                            </div>
                            <div x-show="!currentSafety && safetyError" style="text-align:center; padding:0.75rem; font-size:0.8rem; color:var(--muted-foreground);" x-text="safetyError"></div>
                        </div>

                        <!-- Ask AI Button -->
                        <button x-show="!reviewLoading && !safetyLoading" @click="if (!chatTyping) { chatOpen = true; $nextTick(() => sendChat('Tell me everything about this ' + (selected ? selected.title.replace(/\*/g, ' ').trim() : 'vehicle') + '  is it a good deal?')); }" style="display:block; width:100%; margin-top:1rem; padding:0.6rem; background:linear-gradient(135deg, oklch(0.55 0.22 27), oklch(0.40 0.18 20)); color:#fff; border:1px solid oklch(0.65 0.25 35); font-family:'Oxanium',sans-serif; font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; cursor:pointer;">
                            Ask AI About This Car
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
    function app() {
        return {
            loading: false,
            searched: false,
            error: null,
            allResults: [],
            filtered: [],
            activeSource: 'all',
            sortBy: 'price-asc',
            selected: null,
            modalImages: [],
            modalImgIdx: 0,
            detailLoading: false,
            extraDetails: {},
            descCollapsed: true,
            modalTab: 'details',
            sourceInfo: [],
            darkMode: false,

            // AI features
            reviewCache: {},
            reviewLoading: false,
            reviewError: null,
            currentReview: null,
            safetyCache: {},
            safetyLoading: false,
            safetyError: null,
            currentSafety: null,

            // Chat
            chatOpen: false,
            chatMessages: [],
            chatInput: '',
            chatTyping: false,
            chatHistory: [],
            chatTimeout: null,

            // Market analysis
            marketSummary: null,
            marketLoading: false,
            marketError: null,
            marketExpanded: false,

            // Deal badges
            dealBadges: {},

            // Doom state
            isShaking: false,
            redFlash: false,
            statPop: false,
            searchCount: 0,
            hudState: 'normal',
            selectedDifficulty: 'medium',
            soundEnabled: true,
            audioContext: null,
            toasts: [],
            toastId: 0,
            loadingKey: 0,
            // Three.js state
            threeInitialized: false,
            _threeAnimating: false,
            weaponScene: null,
            weaponCamera: null,
            weaponRenderer: null,
            bgScene: null,
            bgCamera: null,
            bgRenderer: null,
            particleSystems: [],
            bgParticles: null,
            loadingComplete: { craigslist: false, cargurus: false, carscom: false, autotrader: false },
            achievements: {
                firstBlood: false,
                overkill: false,
                bargainHunter: false,
                quadDamage: false,
                multiKill: false,
                godlike: false,
                headshot: false,
            },

            // Saved searches and favorites
            savedSearches: JSON.parse(localStorage.getItem('mvf-saved-searches') || '[]'),
            favorites: JSON.parse(localStorage.getItem('mvf-favorites') || '[]'),
            showSavedSearches: false,

            params: {
                make: '',
                model: '',
                min_year: '',
                max_year: '',
                max_price: '20000',
                max_mileage: '150000',
                zip_code: '53202',
            },

            years: [],
            availableModels: [],

            makes: [
                'Acura','Audi','BMW','Buick','Cadillac','Chevrolet','Chrysler','Dodge',
                'Ford','GMC','Honda','Hyundai','Infiniti','Jeep','Kia','Lexus',
                'Lincoln','Mazda','Mercedes-Benz','Mitsubishi','Nissan','Ram','Subaru',
                'Tesla','Toyota','Volkswagen','Volvo'
            ],

            modelsByMake: {
                'Acura': ['ILX','TLX','RDX','MDX','Integra'],
                'Audi': ['A3','A4','A6','Q3','Q5','Q7','e-tron'],
                'BMW': ['3 Series','5 Series','7 Series','X1','X3','X5','X7'],
                'Buick': ['Encore','Envision','Enclave'],
                'Cadillac': ['CT4','CT5','XT4','XT5','XT6','Escalade'],
                'Chevrolet': ['Malibu','Camaro','Corvette','Equinox','Blazer','Traverse','Tahoe','Suburban','Silverado','Colorado'],
                'Chrysler': ['300','Pacifica','Voyager'],
                'Dodge': ['Charger','Challenger','Durango','Grand Caravan','Hornet'],
                'Ford': ['Fusion','Mustang','Escape','Edge','Explorer','Expedition','F-150','Ranger','Bronco','Maverick'],
                'GMC': ['Terrain','Acadia','Yukon','Sierra','Canyon'],
                'Honda': ['Civic','Accord','HR-V','CR-V','Pilot','Passport','Ridgeline','Odyssey','Fit'],
                'Hyundai': ['Accent','Elantra','Sonata','Kona','Tucson','Santa Fe','Palisade','Ioniq 5'],
                'Infiniti': ['Q50','Q60','QX50','QX60','QX80'],
                'Jeep': ['Renegade','Compass','Cherokee','Grand Cherokee','Wrangler','Gladiator'],
                'Kia': ['Forte','K5','Stinger','Soul','Seltos','Sportage','Sorento','Telluride','EV6'],
                'Lexus': ['IS','ES','NX','RX','GX','LX'],
                'Lincoln': ['Corsair','Nautilus','Aviator','Navigator'],
                'Mazda': ['Mazda3','Mazda6','CX-30','CX-5','CX-9','CX-50','MX-5 Miata'],
                'Mercedes-Benz': ['A-Class','C-Class','E-Class','S-Class','GLA','GLC','GLE','GLS'],
                'Mitsubishi': ['Mirage','Outlander','Eclipse Cross'],
                'Nissan': ['Versa','Sentra','Altima','Maxima','Kicks','Rogue','Murano','Pathfinder','Frontier','Titan'],
                'Ram': ['1500','2500','3500','ProMaster'],
                'Subaru': ['Impreza','Legacy','WRX','Crosstrek','Forester','Outback','Ascent'],
                'Tesla': ['Model 3','Model Y','Model S','Model X'],
                'Toyota': ['Corolla','Camry','Avalon','GR86','Supra','C-HR','RAV4','Highlander','4Runner','Sequoia','Tacoma','Tundra','Prius','Sienna'],
                'Volkswagen': ['Jetta','Passat','Golf','GTI','Tiguan','Atlas','ID.4','Taos'],
                'Volvo': ['S60','S90','XC40','XC60','XC90'],
            },

            init() {
                const cur = new Date().getFullYear() + 1;
                for (let y = cur; y >= 1990; y--) this.years.push(y);
                this.$watch('activeSource', () => this.applySort());
                this.$watch('sortBy', (val) => {
                    localStorage.setItem('mvf-sort', val);
                });

                if (localStorage.getItem('mvf-dark') === '1' ||
                    (!localStorage.getItem('mvf-dark') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    this.darkMode = true;
                }
                if (localStorage.getItem('mvf-sound') === '0') {
                    this.soundEnabled = false;
                }
                const savedSort = localStorage.getItem('mvf-sort');
                if (savedSort) this.sortBy = savedSort;

                // Welcome message in chat
                this.chatMessages.push({ role: 'ai', text: 'Welcome to the AI Advisor. I can help you find the best deals, compare vehicles, check reliability, and answer any car-buying questions. Search for vehicles or ask me anything to get started.' });

                const priceMap = { '50000': 'easy', '20000': 'medium', '10000': 'hard', '5000': 'nightmare' };
                this.selectedDifficulty = priceMap[this.params.max_price] || 'medium';

                // Three.js is lazily initialized on first weapon fire (see _ensureThreeInit)
            },

            _ensureThreeInit() {
                if (this.threeInitialized || typeof THREE === 'undefined') return;
                this.threeInitialized = true;

                // Weapon effects canvas (transparent overlay)
                const weaponCanvas = document.getElementById('weapon-canvas');
                this.weaponScene = new THREE.Scene();
                this.weaponCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.weaponCamera.position.z = 5;
                this.weaponRenderer = new THREE.WebGLRenderer({ canvas: weaponCanvas, alpha: true, antialias: true });
                this.weaponRenderer.setSize(window.innerWidth, window.innerHeight);
                this.weaponRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.weaponRenderer.setClearColor(0x000000, 0);

                // Background canvas (floating embers/particles)
                const bgCanvas = document.getElementById('bg-canvas');
                this.bgScene = new THREE.Scene();
                this.bgCamera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.bgCamera.position.z = 15;
                this.bgRenderer = new THREE.WebGLRenderer({ canvas: bgCanvas, alpha: true, antialias: false });
                this.bgRenderer.setSize(window.innerWidth, window.innerHeight);
                this.bgRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.bgRenderer.setClearColor(0x000000, 0);

                // Create background ember particles
                this._createBgEmbers();

                // Add ambient light to weapon scene
                const light = new THREE.PointLight(0xff6600, 2, 50);
                light.position.set(0, 0, 5);
                this.weaponScene.add(light);

                // Handle resize
                window.addEventListener('resize', () => {
                    const w = window.innerWidth, h = window.innerHeight;
                    [this.weaponCamera, this.bgCamera].forEach(cam => {
                        cam.aspect = w / h;
                        cam.updateProjectionMatrix();
                    });
                    this.weaponRenderer.setSize(w, h);
                    this.bgRenderer.setSize(w, h);
                });

                // Render loop is started on-demand by spawnWeaponEffect
            },

            _createBgEmbers() {
                // Floating ember particles for atmosphere
                const count = 120;
                const geo = new THREE.BufferGeometry();
                const pos = new Float32Array(count * 3);
                const colors = new Float32Array(count * 3);
                const sizes = new Float32Array(count);
                const vels = [];

                for (let i = 0; i < count; i++) {
                    pos[i * 3] = (Math.random() - 0.5) * 40;
                    pos[i * 3 + 1] = (Math.random() - 0.5) * 40;
                    pos[i * 3 + 2] = (Math.random() - 0.5) * 20;

                    // Orange/red ember colors
                    const r = 0.8 + Math.random() * 0.2;
                    const g = 0.2 + Math.random() * 0.4;
                    const b = Math.random() * 0.1;
                    colors[i * 3] = r;
                    colors[i * 3 + 1] = g;
                    colors[i * 3 + 2] = b;

                    sizes[i] = 0.05 + Math.random() * 0.15;

                    vels.push({
                        x: (Math.random() - 0.5) * 0.008,
                        y: 0.005 + Math.random() * 0.02,
                        z: (Math.random() - 0.5) * 0.005,
                        phase: Math.random() * Math.PI * 2,
                    });
                }

                geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
                geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

                const mat = new THREE.PointsMaterial({
                    size: 0.12,
                    transparent: true,
                    opacity: 0.35,
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    sizeAttenuation: true,
                });

                this.bgParticles = new THREE.Points(geo, mat);
                this.bgParticles.userData.velocities = vels;
                this.bgScene.add(this.bgParticles);
            },

            _animateThree() {
                if (!this.threeInitialized) return;

                // Only continue the animation loop if there are active weapon particles
                const hasActiveParticles = this.particleSystems.length > 0;
                if (hasActiveParticles) {
                    requestAnimationFrame(() => this._animateThree());
                } else {
                    this._threeAnimating = false;
                }

                const time = performance.now() * 0.001;

                // Animate background embers
                if (this.bgParticles) {
                    const positions = this.bgParticles.geometry.attributes.position.array;
                    const vels = this.bgParticles.userData.velocities;
                    for (let i = 0; i < vels.length; i++) {
                        // Upward drift with sinusoidal horizontal sway
                        positions[i * 3] += vels[i].x + Math.sin(time + vels[i].phase) * 0.003;
                        positions[i * 3 + 1] += vels[i].y;
                        positions[i * 3 + 2] += vels[i].z;
                        // Wrap
                        if (positions[i * 3 + 1] > 20) {
                            positions[i * 3 + 1] = -20;
                            positions[i * 3] = (Math.random() - 0.5) * 40;
                        }
                    }
                    this.bgParticles.geometry.attributes.position.needsUpdate = true;
                    this.bgParticles.rotation.y = Math.sin(time * 0.1) * 0.05;
                }

                // Animate weapon particle systems
                for (let i = this.particleSystems.length - 1; i >= 0; i--) {
                    const sys = this.particleSystems[i];
                    sys.age += 0.016;

                    if (sys.age >= sys.maxLife) {
                        this.weaponScene.remove(sys.mesh);
                        sys.mesh.geometry.dispose();
                        sys.mesh.material.dispose();
                        this.particleSystems.splice(i, 1);
                        continue;
                    }

                    const t = sys.age / sys.maxLife;
                    sys.mesh.material.opacity = 1.0 - t;
                    sys.mesh.material.size = sys.baseSize * (1.0 + t * 0.5);

                    const positions = sys.mesh.geometry.attributes.position.array;
                    for (let j = 0; j < sys.velocities.length; j++) {
                        positions[j * 3] += sys.velocities[j].x;
                        positions[j * 3 + 1] += sys.velocities[j].y;
                        positions[j * 3 + 2] += sys.velocities[j].z;
                        // Gravity + drag
                        sys.velocities[j].y -= 0.0008;
                        sys.velocities[j].x *= 0.995;
                        sys.velocities[j].z *= 0.995;
                    }
                    sys.mesh.geometry.attributes.position.needsUpdate = true;
                }

                // Render
                this.bgRenderer.render(this.bgScene, this.bgCamera);
                this.weaponRenderer.render(this.weaponScene, this.weaponCamera);
            },

            _spawnThreeExplosion(type, screenX, screenY) {
                // Convert screen coords to Three.js world coords
                const ndcX = (screenX / window.innerWidth) * 2 - 1;
                const ndcY = -(screenY / window.innerHeight) * 2 + 1;
                const vec = new THREE.Vector3(ndcX, ndcY, 0.5);
                vec.unproject(this.weaponCamera);
                const dir = vec.sub(this.weaponCamera.position).normalize();
                const dist = -this.weaponCamera.position.z / dir.z;
                const worldPos = this.weaponCamera.position.clone().add(dir.multiplyScalar(dist));

                const configs = {
                    rocket:   { count: 80, color1: 0xff6600, color2: 0xff2200, size: 0.25, speed: 0.12, life: 1.0 },
                    fireball: { count: 60, color1: 0x80ff40, color2: 0x40cc00, size: 0.2, speed: 0.1, life: 0.85 },
                    plasma:   { count: 50, color1: 0x44aaff, color2: 0x2266ff, size: 0.15, speed: 0.15, life: 0.6 },
                    bfg:      { count: 120, color1: 0x44ff44, color2: 0x00cc22, size: 0.35, speed: 0.14, life: 1.4 },
                    shotgun:  { count: 70, color1: 0xffcc00, color2: 0xff8800, size: 0.12, speed: 0.2, life: 0.5 },
                };

                const cfg = configs[type] || configs.rocket;
                const geo = new THREE.BufferGeometry();
                const positions = new Float32Array(cfg.count * 3);
                const colors = new Float32Array(cfg.count * 3);
                const velocities = [];

                const c1 = new THREE.Color(cfg.color1);
                const c2 = new THREE.Color(cfg.color2);

                for (let i = 0; i < cfg.count; i++) {
                    positions[i * 3] = worldPos.x;
                    positions[i * 3 + 1] = worldPos.y;
                    positions[i * 3 + 2] = worldPos.z;

                    // Random color between c1 and c2
                    const blend = Math.random();
                    colors[i * 3] = c1.r + (c2.r - c1.r) * blend;
                    colors[i * 3 + 1] = c1.g + (c2.g - c1.g) * blend;
                    colors[i * 3 + 2] = c1.b + (c2.b - c1.b) * blend;

                    // Spherical velocity distribution
                    const phi = Math.random() * Math.PI * 2;
                    const theta = Math.random() * Math.PI;
                    const spd = cfg.speed * (0.3 + Math.random() * 0.7);
                    velocities.push({
                        x: Math.sin(theta) * Math.cos(phi) * spd,
                        y: Math.sin(theta) * Math.sin(phi) * spd,
                        z: Math.cos(theta) * spd * 0.3,
                    });
                }

                geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

                const mat = new THREE.PointsMaterial({
                    size: cfg.size,
                    transparent: true,
                    opacity: 1,
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    sizeAttenuation: true,
                });

                const mesh = new THREE.Points(geo, mat);
                this.weaponScene.add(mesh);

                this.particleSystems.push({
                    mesh,
                    velocities,
                    age: 0,
                    maxLife: cfg.life,
                    baseSize: cfg.size,
                });

                // For BFG: add a second wave with delay
                if (type === 'bfg') {
                    setTimeout(() => {
                        this._spawnThreeExplosion('fireball', screenX + (Math.random() - 0.5) * 60, screenY + (Math.random() - 0.5) * 60);
                    }, 200);
                }
            },

            toggleDark() {
                this.darkMode = !this.darkMode;
                localStorage.setItem('mvf-dark', this.darkMode ? '1' : '0');
            },

            onMakeChange() {
                const make = this.params.make;
                this.availableModels = make && this.modelsByMake[make] ? this.modelsByMake[make] : [];
                if (!this.availableModels.includes(this.params.model)) this.params.model = '';
            },

            sourceKey(name) {
                return {
                    'Craigslist': 'craigslist',
                    'CarGurus': 'cargurus',
                    'Cars.com': 'carscom',
                    'AutoTrader': 'autotrader',
                }[name] || 'craigslist';
            },

            // --- Vehicle info parser ---

            _parseVehicleInfo(v) {
                // Try search params first, then parse from title
                let make = this.params.make || '';
                let model = this.params.model || '';
                let year = v.year || '';

                // If make/model missing from params, try to parse from title
                if ((!make || !model) && v.title) {
                    const title = v.title.replace(/\*/g, ' ').replace(/[^a-zA-Z0-9\s-]/g, ' ').replace(/\s+/g, ' ').trim();
                    const words = title.split(' ');

                    // Find year (4-digit number between 1990-2030)
                    if (!year) {
                        for (const w of words) {
                            const n = parseInt(w);
                            if (n >= 1990 && n <= 2030) { year = String(n); break; }
                        }
                    }

                    // Try to match make from our known makes list
                    if (!make) {
                        for (const m of this.makes) {
                            if (title.toLowerCase().includes(m.toLowerCase())) {
                                make = m;
                                break;
                            }
                        }
                    }

                    // Try to find model after the make
                    if (make && !model) {
                        const makeIdx = title.toLowerCase().indexOf(make.toLowerCase());
                        if (makeIdx >= 0) {
                            const afterMake = title.substring(makeIdx + make.length).trim();
                            const modelWords = afterMake.split(/[\s*,]+/);
                            if (modelWords[0] && modelWords[0].length > 1) {
                                // Check known models first
                                const knownModels = this.modelsByMake[make] || [];
                                let foundModel = '';
                                for (const km of knownModels) {
                                    if (afterMake.toLowerCase().startsWith(km.toLowerCase())) {
                                        foundModel = km;
                                        break;
                                    }
                                }
                                model = foundModel || modelWords[0];
                            }
                        }
                    }
                }
                return { make, model, year };
            },

            // --- AI Feature Methods ---

            _cacheGet(key) {
                try {
                    const raw = localStorage.getItem('mvf-' + key);
                    if (!raw) return null;
                    const entry = JSON.parse(raw);
                    if (Date.now() - entry.ts > 24 * 60 * 60 * 1000) {
                        localStorage.removeItem('mvf-' + key);
                        return null;
                    }
                    return entry.data;
                } catch (e) { return null; }
            },

            _cacheSet(key, data) {
                try {
                    localStorage.setItem('mvf-' + key, JSON.stringify({ ts: Date.now(), data }));
                } catch (e) { /* quota exceeded, ignore */ }
            },

            async fetchReview() {
                if (!this.selected) return;
                const v = this.selected;
                const info = this._parseVehicleInfo(v);
                const make = info.make;
                const model = info.model;
                const year = info.year;
                if (!make || !model || !year) { this.reviewError = 'Could not identify vehicle make, model, or year.'; return; }
                const key = 'review_' + (make + '_' + model + '_' + year).toLowerCase();
                if (this.reviewCache[key]) { this.currentReview = this.reviewCache[key]; return; }
                const cached = this._cacheGet(key);
                if (cached) { this.reviewCache[key] = cached; this.currentReview = cached; return; }
                this.reviewLoading = true; this.reviewError = null; this.currentReview = null;
                const reviewController = new AbortController();
                const reviewTimeout = setTimeout(() => reviewController.abort(), 20000);
                try {
                    const resp = await fetch('/api/review', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ make, model, year: parseInt(year), price: v.price, mileage: v.mileage || 0 }),
                        signal: reviewController.signal
                    });
                    clearTimeout(reviewTimeout);
                    const data = await resp.json();
                    if (data.success !== false && data.review) {
                        this.reviewCache[key] = data.review;
                        this._cacheSet(key, data.review);
                        this.currentReview = data.review;
                    } else {
                        this.reviewError = data.error || 'Could not load AI review.';
                    }
                } catch(e) {
                    if (e.name === 'AbortError') {
                        this.reviewError = 'Review request timed out.';
                    } else {
                        this.reviewError = 'AI review service unavailable.';
                    }
                }
                finally { this.reviewLoading = false; }
            },

            async fetchSafety() {
                if (!this.selected) return;
                const v = this.selected;
                const info = this._parseVehicleInfo(v);
                const make = info.make;
                const model = info.model;
                const year = info.year;
                if (!make || !model || !year) { this.safetyError = 'Could not identify vehicle make, model, or year.'; return; }
                const key = 'safety_' + (make + '_' + model + '_' + year).toLowerCase();
                if (this.safetyCache[key]) { this.currentSafety = this.safetyCache[key]; return; }
                const cached = this._cacheGet(key);
                if (cached) { this.safetyCache[key] = cached; this.currentSafety = cached; return; }
                this.safetyLoading = true; this.safetyError = null; this.currentSafety = null;
                const safetyController = new AbortController();
                const safetyTimeout = setTimeout(() => safetyController.abort(), 15000);
                try {
                    const resp = await fetch('/api/safety?make=' + encodeURIComponent(make) + '&model=' + encodeURIComponent(model) + '&year=' + encodeURIComponent(year), {
                        signal: safetyController.signal
                    });
                    clearTimeout(safetyTimeout);
                    const data = await resp.json();
                    if (data.success !== false) {
                        this.safetyCache[key] = data;
                        this._cacheSet(key, data);
                        this.currentSafety = data;
                    } else {
                        this.safetyError = data.error || 'Could not load safety data.';
                    }
                } catch(e) {
                    if (e.name === 'AbortError') {
                        this.safetyError = 'Safety request timed out.';
                    } else {
                        this.safetyError = 'Safety data service unavailable.';
                    }
                }
                finally { this.safetyLoading = false; }
            },

            get chatChips() {
                if (this.selected) {
                    return ['Is this a good deal?', 'Known issues?', 'Negotiate tips', 'Similar alternatives?'];
                }
                if (this.allResults.length > 0) {
                    return ['Which is the best deal?', 'Compare top 3', 'Any red flags?', 'Best value pick?'];
                }
                return ['Reliable SUVs under $20k?', 'Best value sedans?', 'What should I look for?', 'Milwaukee market tips?'];
            },

            async sendChat(text) {
                if (this.chatTyping) return;
                if (!text || !text.trim()) return;
                const msg = text.trim();
                this.chatInput = '';
                this.chatMessages.push({ role: 'user', text: msg });
                this.chatTyping = true;
                this.$nextTick(() => { if (this.$refs.chatMessages) this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight; });

                // Build messages array and context for the backend API
                this.chatHistory.push({ role: 'user', content: msg });
                const context = {};
                if (this.selected) {
                    const vInfo = this._parseVehicleInfo(this.selected);
                    context.current_vehicle = {
                        title: this.selected.title,
                        price: this.selected.price,
                        year: this.selected.year,
                        mileage: this.selected.mileage,
                        source: this.selected.source,
                        make: vInfo.make,
                        model: vInfo.model,
                    };
                }
                if (this.allResults.length > 0) {
                    context.search_results_summary = {
                        total: this.allResults.length,
                        avg_price: this.avgPrice,
                        min_price: this.bestDeal,
                        make: this.params.make || '',
                        model: this.params.model || '',
                    };
                    context.top_vehicles = this.filtered.slice(0, 5).map(v => ({
                        title: v.title, price: v.price, year: v.year, mileage: v.mileage, source: v.source
                    }));
                }

                // 45-second timeout (Gemini can be slow on cold starts)
                const controller = new AbortController();
                this.chatTimeout = setTimeout(() => {
                    controller.abort();
                }, 45000);

                try {
                    const resp = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: this.chatHistory, context }),
                        signal: controller.signal
                    });
                    clearTimeout(this.chatTimeout);
                    if (resp.status === 429) {
                        this.chatTyping = false;
                        this.chatMessages.push({ role: 'ai', text: 'Rate limit reached. Please wait a moment before sending another message.', isError: true });
                        this.chatHistory.pop();
                        return;
                    }
                    if (resp.status === 401 || resp.status === 403) {
                        this.chatTyping = false;
                        this.chatMessages.push({ role: 'ai', text: 'AI chat is not configured. The API key may be missing. Basic vehicle search still works.', isError: true });
                        this.chatHistory.pop();
                        return;
                    }
                    const data = await resp.json();
                    if (data.error) {
                        this.chatTyping = false;
                        this.chatMessages.push({ role: 'ai', text: data.error, isError: true });
                        this.chatHistory.pop();
                        return;
                    }
                    const fullText = data.response || data.message || 'No response received.';
                    this.chatTyping = false;
                    this.chatHistory.push({ role: 'assistant', content: fullText });
                    this.chatMessages.push({ role: 'ai', text: '' });
                    const idx = this.chatMessages.length - 1;
                    for (let i = 0; i < fullText.length; i++) {
                        await new Promise(r => setTimeout(r, 15));
                        this.chatMessages[idx].text = fullText.substring(0, i + 1);
                        if (i % 10 === 0 && this.$refs.chatMessages) this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight;
                    }
                } catch(e) {
                    clearTimeout(this.chatTimeout);
                    this.chatTyping = false;
                    if (e.name === 'AbortError') {
                        this.chatMessages.push({ role: 'ai', text: 'Request timed out. The AI service may be loading. Please try again in a moment.', isError: true });
                    } else {
                        this.chatMessages.push({ role: 'ai', text: 'Chat service unavailable. Please try again.', isError: true });
                    }
                    this.chatHistory.pop();
                }
                if (this.$refs.chatMessages) this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight;
            },

            renderMarkdown(text) {
                if (!text) return '';
                let s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
                s = s.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
                s = s.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                s = s.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener" style="color:var(--primary);">$1</a>');
                s = s.replace(/\n/g, '<br>');
                return s;
            },

            formatDescription(text) {
                if (!text) return '';
                let s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                s = s.replace(/([.!?])(\s*)([A-Z])/g, '$1\n\n$3');
                s = s.replace(/(ADDRESS\s*:|LOCATION\s*:|CALL\s|CONTACT\s|TEXT\s|PHONE\s*:|PRICE\s*:)/gi, '\n\n$1');
                s = s.replace(/(https?:\/\/|www\.)/gi, '\n$1');
                s = s.replace(/,\s*([A-Z]{2,})/g, '\n$1');
                s = s.replace(/\n{3,}/g, '\n\n');
                const emojiMap = [
                    [/\b(AWD|4WD|ALL WHEEL DRIVE|ALL-WHEEL DRIVE)\b/gi, ' $1'],
                    [/\b(FWD|FRONT WHEEL DRIVE)\b/gi, ' $1'],
                    [/\b(RWD|REAR WHEEL DRIVE)\b/gi, ' $1'],
                    [/\b(V6|V8|V4|I4|I6)\b/gi, ' $1'],
                    [/\b(LOW MILES|LOW MILEAGE)\b/gi, ' $1'],
                    [/\b(CLEAN TITLE|CLEAR TITLE|CLEAN AND CLEAR TITLE)\b/gi, ' $1'],
                    [/\b(LOADED)\b/gi, ' $1'],
                    [/\b(SUNROOF|MOONROOF)\b/gi, ' $1'],
                    [/\b(LEATHER)\b/gi, ' $1'],
                    [/\b(HEATED SEATS)\b/gi, ' $1'],
                    [/\b(NAVIGATION|NAV)\b/gi, ' $1'],
                    [/\b(BLUETOOTH)\b/gi, ' $1'],
                    [/\b(BACKUP CAMERA|REAR CAMERA|REARVIEW CAMERA)\b/gi, ' $1'],
                    [/\b(CRUISE CONTROL)\b/gi, ' $1'],
                    [/\b(POWER WINDOWS)\b/gi, ' $1'],
                    [/\b(POWER DOOR LOCKS)\b/gi, ' $1'],
                    [/\b(FOG LIGHTS)\b/gi, ' $1'],
                    [/\b(PREMIUM SOUND|PREMIUM AUDIO|SOUND SYSTEM)\b/gi, ' $1'],
                    [/\b(CD RADIO|AM FM|RADIO)\b/gi, ' $1'],
                    [/\b(AIR CONDITIONING|A\/C|AC)\b/gi, ' $1'],
                    [/\b(WARRANTY)\b/gi, ' $1'],
                    [/\b(DUAL POWER SEATS|POWER SEATS)\b/gi, ' $1'],
                    [/\b(KEYLESS|KEY FOB|PUSH START)\b/gi, ' $1'],
                    [/\b(AUTOMATIC|AUTO TRANS)\b/gi, ' $1'],
                    [/\b(MANUAL|STICK SHIFT|6 SPEED|5 SPEED)\b/gi, ' $1'],
                    [/\b(TURBO|TURBOCHARGED)\b/gi, ' $1'],
                    [/\b(HYBRID|ELECTRIC)\b/gi, ' $1'],
                    [/\b(MILES)\b/gi, ' $1'],
                    [/\b(TOW|TOWING)\b/gi, ' $1'],
                ];
                for (const [pattern, replacement] of emojiMap) {
                    s = s.replace(pattern, replacement);
                }
                s = s.replace(/(\d{3}[-.\s]?\d{3}[-.\s]?\d{4})/g, ' $1');
                s = s.replace(/(https?:\/\/\S+|www\.\S+)/gi, ' $1');
                s = s.replace(/(ADDRESS\s*:)/gi, ' $1');
                return s.trim();
            },

            get avgPrice() {
                if (this.filtered.length === 0) return 0;
                return Math.round(this.filtered.reduce((s, v) => s + v.price, 0) / this.filtered.length);
            },

            get bestDeal() {
                if (this.filtered.length === 0) return null;
                return Math.min(...this.filtered.map(v => v.price));
            },

            get sourcesWithResults() {
                return this.sourceInfo.filter(s => s.count > 0).length;
            },

            get sourcesTotal() {
                return this.sourceInfo.length;
            },

            get searchHealth() {
                if (!this.searched) return 100;
                const healthy = this.sourceInfo.filter(s => s.count > 0).length;
                const total = this.sourceInfo.length || 4;
                return Math.round((healthy / total) * 100);
            },

            get hudFace() {
                switch (this.hudState) {
                    case 'searching': return '>:|';
                    case 'results': return '>:D';
                    case 'error': return 'X_X';
                    default: return '>:)';
                }
            },

            applySort() {
                let list = this.allResults;
                if (this.activeSource !== 'all') {
                    list = list.filter(v => v.source === this.activeSource);
                }
                this.filtered = [...list];
                const [field, dir] = this.sortBy.split('-');
                const asc = dir === 'asc';
                this.filtered.sort((a, b) => {
                    let va, vb;
                    if (field === 'price') { va = a.price || 0; vb = b.price || 0; }
                    else if (field === 'mileage') { va = a.mileage || 999999; vb = b.mileage || 999999; }
                    else if (field === 'year') { va = a.year || 0; vb = b.year || 0; }
                    return asc ? va - vb : vb - va;
                });
            },

            // Sound system
            initAudio() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // Pre-generate noise buffer for explosion textures
                    const sr = this.audioContext.sampleRate;
                    this._noiseBuffer = this.audioContext.createBuffer(1, sr * 2, sr);
                    const data = this._noiseBuffer.getChannelData(0);
                    for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
                    // Waveshaper for distortion
                    this._distCurve = new Float32Array(44100);
                    for (let i = 0; i < 44100; i++) {
                        const x = (i * 2) / 44100 - 1;
                        this._distCurve[i] = (Math.PI + 8) * x / (Math.PI + 8 * Math.abs(x));
                    }
                }
            },

            _createNoise(ctx, duration, filterFreq, filterType, gain, startTime) {
                const src = ctx.createBufferSource();
                src.buffer = this._noiseBuffer;
                const flt = ctx.createBiquadFilter();
                flt.type = filterType || 'lowpass';
                flt.frequency.setValueAtTime(filterFreq || 1000, startTime);
                const g = ctx.createGain();
                g.gain.setValueAtTime(gain || 0.15, startTime);
                g.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                src.connect(flt); flt.connect(g); g.connect(ctx.destination);
                src.start(startTime); src.stop(startTime + duration);
                return { src, flt, g };
            },

            _createDistortedOsc(ctx, type, freq, freqEnd, duration, gain, startTime) {
                const o = ctx.createOscillator();
                const ws = ctx.createWaveShaper();
                ws.curve = this._distCurve;
                const flt = ctx.createBiquadFilter();
                flt.type = 'lowpass';
                flt.frequency.setValueAtTime(2000, startTime);
                flt.frequency.exponentialRampToValueAtTime(200, startTime + duration);
                const g = ctx.createGain();
                o.type = type;
                o.frequency.setValueAtTime(freq, startTime);
                o.frequency.exponentialRampToValueAtTime(freqEnd, startTime + duration);
                g.gain.setValueAtTime(gain, startTime);
                g.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                o.connect(ws); ws.connect(flt); flt.connect(g); g.connect(ctx.destination);
                o.start(startTime); o.stop(startTime + duration);
                return o;
            },

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                localStorage.setItem('mvf-sound', this.soundEnabled ? '1' : '0');
                if (this.soundEnabled) {
                    this.initAudio();
                    this.playSound('pickup');
                }
            },

            playSound(type) {
                if (!this.soundEnabled) return;
                this.initAudio();
                const ctx = this.audioContext;
                if (!ctx) return;
                const now = ctx.currentTime;

                switch(type) {
                    case 'achievement': {
                        // Rich fanfare: layered sine+triangle with reverb-like tail
                        [523, 659, 784].forEach((freq, i) => {
                            const t = now + i * 0.1;
                            ['sine', 'triangle'].forEach((waveType, j) => {
                                const o = ctx.createOscillator();
                                const flt = ctx.createBiquadFilter();
                                flt.type = 'lowpass';
                                flt.frequency.setValueAtTime(4000, t);
                                flt.frequency.exponentialRampToValueAtTime(800, t + 0.5);
                                const g = ctx.createGain();
                                o.type = waveType;
                                o.frequency.setValueAtTime(freq + (j * 2), t);
                                g.gain.setValueAtTime(j === 0 ? 0.07 : 0.04, t);
                                g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                                o.connect(flt); flt.connect(g); g.connect(ctx.destination);
                                o.start(t); o.stop(t + 0.5);
                            });
                        });
                        // Shimmer noise
                        this._createNoise(ctx, 0.4, 6000, 'bandpass', 0.02, now);
                        break;
                    }
                    case 'fire': {
                        // Punchy search initiate: noise burst + sub bass thud
                        this._createNoise(ctx, 0.15, 800, 'lowpass', 0.12, now);
                        this._createDistortedOsc(ctx, 'sine', 80, 30, 0.2, 0.15, now);
                        // Transient click
                        const click = ctx.createOscillator();
                        const cg = ctx.createGain();
                        click.type = 'square';
                        click.frequency.setValueAtTime(1500, now);
                        click.frequency.exponentialRampToValueAtTime(200, now + 0.02);
                        cg.gain.setValueAtTime(0.1, now);
                        cg.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
                        click.connect(cg); cg.connect(ctx.destination);
                        click.start(now); click.stop(now + 0.03);
                        break;
                    }
                    case 'pickup': {
                        // Satisfying results chime: rising filtered tones
                        [400, 600, 800].forEach((freq, i) => {
                            const t = now + i * 0.06;
                            const o = ctx.createOscillator();
                            const flt = ctx.createBiquadFilter();
                            flt.type = 'lowpass';
                            flt.frequency.setValueAtTime(3000, t);
                            const g = ctx.createGain();
                            o.type = 'sine';
                            o.frequency.setValueAtTime(freq, t);
                            o.frequency.exponentialRampToValueAtTime(freq * 1.02, t + 0.2);
                            g.gain.setValueAtTime(0.06, t);
                            g.gain.exponentialRampToValueAtTime(0.001, t + 0.25);
                            o.connect(flt); flt.connect(g); g.connect(ctx.destination);
                            o.start(t); o.stop(t + 0.25);
                        });
                        this._createNoise(ctx, 0.12, 5000, 'highpass', 0.015, now);
                        break;
                    }
                    case 'damage': {
                        // Heavy error: distorted descending noise + bass
                        this._createNoise(ctx, 0.4, 600, 'lowpass', 0.18, now);
                        this._createDistortedOsc(ctx, 'sawtooth', 250, 60, 0.35, 0.12, now);
                        this._createDistortedOsc(ctx, 'square', 180, 40, 0.3, 0.06, now + 0.05);
                        break;
                    }
                }
            },

            setDifficulty(name, price) {
                this.selectedDifficulty = name;
                this.params.max_price = price;
                this.playSound('pickup');
            },

            // Screen shake
            triggerShake() {
                this.isShaking = true;
                setTimeout(() => { this.isShaking = false; }, 500);
            },

            // Red flash
            triggerRedFlash() {
                this.redFlash = true;
                setTimeout(() => { this.redFlash = false; }, 400);
            },

            // Stat pop
            triggerStatPop() {
                this.statPop = true;
                setTimeout(() => { this.statPop = false; }, 500);
            },

            // Weapon system
            weaponIndex: 0,
            weapons: [
                { name: 'ROCKET LAUNCHER', key: 'rocket' },
                { name: 'IMP FIREBALL', key: 'fireball' },
                { name: 'PLASMA RIFLE', key: 'plasma' },
                { name: 'BFG 9000', key: 'bfg' },
                { name: 'SUPER SHOTGUN', key: 'shotgun' },
            ],

            fireWeaponAndOpen(event, vehicle) {
                const weapon = this.weapons[this.weaponIndex % this.weapons.length];
                this.weaponIndex++;
                const x = event.clientX;
                const y = event.clientY;

                // Hit flash on the card
                const card = event.currentTarget;
                card.classList.add('card-hit-flash');
                setTimeout(() => card.classList.remove('card-hit-flash'), 300);

                // Fire the weapon effect
                this.spawnWeaponEffect(weapon.key, x, y);
                this.playWeaponSound(weapon.key);
                this.showWeaponName(weapon.name);

                // Small screen shake for big weapons
                if (weapon.key === 'rocket' || weapon.key === 'bfg' || weapon.key === 'shotgun') {
                    this.triggerShake();
                }

                // Delay modal open slightly so the blast is visible
                setTimeout(() => this.openModal(vehicle), 200);
            },

            showWeaponName(name) {
                const el = document.createElement('div');
                el.className = 'weapon-name-hud';
                el.textContent = name;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 900);
            },

            spawnWeaponEffect(type, x, y) {
                // Lazily initialize Three.js on first weapon fire
                this._ensureThreeInit();

                // Spawn 3D WebGL particles (real depth + glow)
                if (this.threeInitialized) {
                    this._spawnThreeExplosion(type, x, y);
                    // Restart animation loop if it's not already running
                    if (!this._threeAnimating) {
                        this._threeAnimating = true;
                        requestAnimationFrame(() => this._animateThree());
                    }
                }

                // Also spawn DOM effects for the 2D overlay (shockwaves, etc.)
                const container = document.createElement('div');
                container.className = 'weapon-impact';
                container.style.left = x + 'px';
                container.style.top = y + 'px';
                document.body.appendChild(container);

                switch (type) {
                    case 'rocket': this._spawnRocket(container); break;
                    case 'fireball': this._spawnFireball(container); break;
                    case 'plasma': this._spawnPlasma(container); break;
                    case 'bfg': this._spawnBfg(container); break;
                    case 'shotgun': this._spawnShotgun(container); break;
                }

                const dur = type === 'bfg' ? 1200 : 800;
                setTimeout(() => container.remove(), dur);
            },

            _spawnRocket(container) {
                const frag = document.createDocumentFragment();

                // Core explosion with radial gradient
                const core = document.createElement('div');
                core.className = 'weapon-core';
                core.style.animation = 'rocketCore 700ms ease-out forwards';
                frag.appendChild(core);

                // Double shockwave rings
                for (let w = 0; w < 2; w++) {
                    const wave = document.createElement('div');
                    wave.className = 'weapon-shockwave';
                    wave.style.animation = 'rocketShockwave 600ms ease-out forwards';
                    wave.style.animationDelay = w * 80 + 'ms';
                    frag.appendChild(wave);
                }

                // Hot debris particles with glow trails
                for (let i = 0; i < 20; i++) {
                    const p = document.createElement('div');
                    p.className = 'weapon-particle';
                    const angle = (Math.PI * 2 * i / 20) + (Math.random() - 0.5) * 0.6;
                    const dist = 70 + Math.random() * 100;
                    p.style.setProperty('--px', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--py', Math.sin(angle) * dist + 'px');
                    const size = 3 + Math.random() * 6;
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';
                    const colors = ['#fff', '#ffee88', '#ffaa00', '#ff6600', '#ff2200'];
                    p.style.background = colors[Math.floor(Math.random() * colors.length)];
                    p.style.boxShadow = `0 0 ${4 + Math.random() * 8}px ${p.style.background}`;
                    p.style.animation = `rocketParticle ${450 + Math.random() * 350}ms ease-out forwards`;
                    p.style.animationDelay = Math.random() * 60 + 'ms';
                    frag.appendChild(p);
                }

                // Glowing ember trails
                for (let i = 0; i < 8; i++) {
                    const e = document.createElement('div');
                    e.className = 'weapon-particle';
                    const angle = Math.random() * Math.PI * 2;
                    const dist = 30 + Math.random() * 60;
                    e.style.setProperty('--ex', Math.cos(angle) * dist + 'px');
                    e.style.setProperty('--ey', Math.sin(angle) * dist + 'px');
                    const ec = Math.random() > 0.5 ? '#ffaa00' : '#ff4400';
                    e.style.setProperty('--ec', ec);
                    e.style.width = '3px'; e.style.height = '3px';
                    e.style.background = ec;
                    e.style.animation = `rocketEmber ${600 + Math.random() * 400}ms ease-out forwards`;
                    e.style.animationDelay = (50 + Math.random() * 150) + 'ms';
                    frag.appendChild(e);
                }

                // Thick smoke plumes
                for (let i = 0; i < 10; i++) {
                    const s = document.createElement('div');
                    s.className = 'weapon-particle';
                    s.style.setProperty('--sx', (Math.random() - 0.5) * 80 + 'px');
                    s.style.setProperty('--sy', -(20 + Math.random() * 70) + 'px');
                    const smokeSize = 10 + Math.random() * 18;
                    s.style.width = smokeSize + 'px';
                    s.style.height = smokeSize + 'px';
                    s.style.animation = `rocketSmoke ${600 + Math.random() * 500}ms ease-out forwards`;
                    s.style.animationDelay = (80 + Math.random() * 250) + 'ms';
                    frag.appendChild(s);
                }

                container.appendChild(frag);
            },

            _spawnFireball(container) {
                const frag = document.createDocumentFragment();

                // Core with inner glow
                const core = document.createElement('div');
                core.className = 'weapon-core';
                core.style.animation = 'fireballCore 650ms ease-out forwards';
                frag.appendChild(core);

                // Double expanding ring
                for (let r = 0; r < 2; r++) {
                    const ring = document.createElement('div');
                    ring.className = 'weapon-shockwave';
                    ring.style.animation = 'fireballRing 550ms ease-out forwards';
                    ring.style.animationDelay = r * 100 + 'ms';
                    frag.appendChild(ring);
                }

                // Many ember particles with varied sizes
                for (let i = 0; i < 16; i++) {
                    const p = document.createElement('div');
                    p.className = 'weapon-particle';
                    const angle = (Math.PI * 2 * i / 16) + (Math.random() - 0.5) * 0.9;
                    const dist = 50 + Math.random() * 90;
                    p.style.setProperty('--px', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--py', Math.sin(angle) * dist + 'px');
                    const size = 3 + Math.random() * 6;
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';
                    p.style.animation = `fireballEmber ${450 + Math.random() * 350}ms ease-out forwards`;
                    p.style.animationDelay = Math.random() * 100 + 'ms';
                    frag.appendChild(p);
                }

                // Green smoke wisps
                for (let i = 0; i < 6; i++) {
                    const w = document.createElement('div');
                    w.className = 'weapon-particle';
                    w.style.setProperty('--wx', (Math.random() - 0.5) * 70 + 'px');
                    w.style.setProperty('--wy', -(20 + Math.random() * 50) + 'px');
                    const ws = 12 + Math.random() * 14;
                    w.style.width = ws + 'px';
                    w.style.height = ws + 'px';
                    w.style.animation = `fireballWisp ${500 + Math.random() * 400}ms ease-out forwards`;
                    w.style.animationDelay = (100 + Math.random() * 200) + 'ms';
                    frag.appendChild(w);
                }

                container.appendChild(frag);
            },

            _spawnPlasma(container) {
                const frag = document.createDocumentFragment();

                // Core flash
                const core = document.createElement('div');
                core.className = 'weapon-core';
                core.style.animation = 'plasmaCore 450ms ease-out forwards';
                frag.appendChild(core);

                // Ripple rings
                for (let r = 0; r < 3; r++) {
                    const rp = document.createElement('div');
                    rp.className = 'weapon-shockwave';
                    rp.style.animation = 'plasmaRipple 400ms ease-out forwards';
                    rp.style.animationDelay = r * 60 + 'ms';
                    frag.appendChild(rp);
                }

                // Electric arcs - more of them, varied
                for (let i = 0; i < 12; i++) {
                    const arc = document.createElement('div');
                    arc.style.position = 'absolute';
                    arc.style.transformOrigin = '50% 0';
                    const angle = (Math.PI * 2 * i / 12) + (Math.random() - 0.5) * 0.5;
                    arc.style.transform = `translate(-50%, 0) rotate(${angle}rad)`;
                    const len = 25 + Math.random() * 65;
                    arc.style.setProperty('--arc-len', len + 'px');
                    arc.style.animation = `plasmaArc ${250 + Math.random() * 250}ms ease-out forwards`;
                    arc.style.animationDelay = Math.random() * 80 + 'ms';
                    frag.appendChild(arc);
                }

                // Crackling sparks - more
                for (let i = 0; i < 18; i++) {
                    const sp = document.createElement('div');
                    sp.className = 'weapon-particle';
                    const angle = Math.random() * Math.PI * 2;
                    const dist = 15 + Math.random() * 60;
                    sp.style.setProperty('--px', Math.cos(angle) * dist + 'px');
                    sp.style.setProperty('--py', Math.sin(angle) * dist + 'px');
                    const sz = 2 + Math.random() * 3;
                    sp.style.width = sz + 'px';
                    sp.style.height = sz + 'px';
                    sp.style.animation = `plasmaSpark ${180 + Math.random() * 280}ms ease-out forwards`;
                    sp.style.animationDelay = Math.random() * 120 + 'ms';
                    frag.appendChild(sp);
                }

                container.appendChild(frag);
            },

            _spawnBfg(container) {
                // Positioned screen flash (appended to body, not container)
                const flash = document.createElement('div');
                flash.className = 'bfg-screen-flash';
                const rect = container.getBoundingClientRect ? null : null;
                flash.style.setProperty('--bfg-x', container.style.left);
                flash.style.setProperty('--bfg-y', container.style.top);
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 900);

                const frag = document.createDocumentFragment();

                // Massive core
                const core = document.createElement('div');
                core.className = 'weapon-core';
                core.style.animation = 'bfgCore 1000ms ease-out forwards';
                frag.appendChild(core);

                // Triple shockwave
                for (let w = 0; w < 3; w++) {
                    const wave = document.createElement('div');
                    wave.className = 'weapon-shockwave';
                    wave.style.animation = 'bfgShockwave 800ms ease-out forwards';
                    wave.style.animationDelay = w * 120 + 'ms';
                    frag.appendChild(wave);
                }

                // Secondary explosions - more, varied distance
                for (let i = 0; i < 8; i++) {
                    const sec = document.createElement('div');
                    sec.className = 'weapon-core';
                    const angle = (Math.PI * 2 * i / 8) + (Math.random() - 0.5) * 0.4;
                    const dist = 50 + Math.random() * 70;
                    sec.style.left = Math.cos(angle) * dist + 'px';
                    sec.style.top = Math.sin(angle) * dist + 'px';
                    sec.style.animation = `bfgSecondary ${400 + Math.random() * 400}ms ease-out forwards`;
                    sec.style.animationDelay = (150 + Math.random() * 350) + 'ms';
                    frag.appendChild(sec);
                }

                // Energy tendrils radiating outward
                for (let i = 0; i < 10; i++) {
                    const t = document.createElement('div');
                    t.style.position = 'absolute';
                    t.style.transformOrigin = '50% 0';
                    const angle = (Math.PI * 2 * i / 10) + (Math.random() - 0.5) * 0.3;
                    t.style.transform = `translate(-50%, 0) rotate(${angle}rad)`;
                    const len = 60 + Math.random() * 100;
                    t.style.setProperty('--t-len', len + 'px');
                    t.style.width = '2px';
                    t.style.background = '#66ff66';
                    t.style.boxShadow = '0 0 6px #00ff44';
                    t.style.animation = `bfgTendril ${400 + Math.random() * 300}ms ease-out forwards`;
                    t.style.animationDelay = (100 + Math.random() * 200) + 'ms';
                    frag.appendChild(t);
                }

                // Green particles - more
                for (let i = 0; i < 24; i++) {
                    const p = document.createElement('div');
                    p.className = 'weapon-particle';
                    const angle = Math.random() * Math.PI * 2;
                    const dist = 80 + Math.random() * 150;
                    p.style.setProperty('--px', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--py', Math.sin(angle) * dist + 'px');
                    const sz = 3 + Math.random() * 7;
                    p.style.width = sz + 'px';
                    p.style.height = sz + 'px';
                    p.style.background = Math.random() > 0.3 ? '#88ff88' : '#ccffcc';
                    p.style.boxShadow = `0 0 ${6 + Math.random() * 10}px #00ff44`;
                    p.style.animation = `rocketParticle ${500 + Math.random() * 500}ms ease-out forwards`;
                    p.style.animationDelay = Math.random() * 200 + 'ms';
                    frag.appendChild(p);
                }

                container.appendChild(frag);
            },

            _spawnShotgun(container) {
                const frag = document.createDocumentFragment();

                // Bright muzzle flash
                const flash = document.createElement('div');
                flash.className = 'weapon-core';
                flash.style.animation = 'shotgunFlash 300ms ease-out forwards';
                frag.appendChild(flash);

                // Smoke ring
                const smoke = document.createElement('div');
                smoke.className = 'weapon-shockwave';
                smoke.style.animation = 'shotgunSmokeRing 500ms ease-out forwards';
                smoke.style.animationDelay = '50ms';
                frag.appendChild(smoke);

                // Pellet spread - wider, more varied
                for (let i = 0; i < 30; i++) {
                    const p = document.createElement('div');
                    p.className = 'weapon-particle';
                    const angle = (Math.random() - 0.5) * Math.PI * 1.4;
                    const dist = 35 + Math.random() * 130;
                    p.style.setProperty('--px', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--py', Math.sin(angle) * dist + 'px');
                    const size = 2 + Math.random() * 5;
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';
                    const pc = ['#fff', '#ffee88', '#ffcc00', '#ffaa00', '#ff8800'][Math.floor(Math.random() * 5)];
                    p.style.setProperty('--pc', pc);
                    p.style.background = pc;
                    p.style.animation = `shotgunPellet ${180 + Math.random() * 280}ms ease-out forwards`;
                    p.style.animationDelay = Math.random() * 40 + 'ms';
                    frag.appendChild(p);
                }

                container.appendChild(frag);
            },

            playWeaponSound(type) {
                if (!this.soundEnabled) return;
                this.initAudio();
                const ctx = this.audioContext;
                if (!ctx) return;
                const now = ctx.currentTime;

                switch (type) {
                    case 'rocket': {
                        // Heavy explosion: noise burst + filtered sub-bass + distorted mid
                        this._createNoise(ctx, 0.5, 400, 'lowpass', 0.2, now);
                        this._createNoise(ctx, 0.3, 2000, 'bandpass', 0.08, now);
                        this._createDistortedOsc(ctx, 'sine', 50, 20, 0.5, 0.2, now);
                        this._createDistortedOsc(ctx, 'sawtooth', 120, 30, 0.3, 0.08, now + 0.02);
                        // Crackle tail
                        this._createNoise(ctx, 0.4, 3000, 'highpass', 0.04, now + 0.1);
                        break;
                    }
                    case 'fireball': {
                        // Whoosh: filtered noise sweep + resonant tone
                        const n = this._createNoise(ctx, 0.4, 300, 'bandpass', 0.12, now);
                        n.flt.frequency.exponentialRampToValueAtTime(2000, now + 0.15);
                        n.flt.frequency.exponentialRampToValueAtTime(200, now + 0.4);
                        n.flt.Q.setValueAtTime(5, now);
                        this._createDistortedOsc(ctx, 'sawtooth', 100, 300, 0.2, 0.08, now);
                        // Sizzle
                        this._createNoise(ctx, 0.3, 4000, 'highpass', 0.03, now + 0.05);
                        break;
                    }
                    case 'plasma': {
                        // Electric zap: modulated noise + detuned oscillators
                        this._createNoise(ctx, 0.2, 3000, 'bandpass', 0.1, now);
                        // Rapidly modulated tone for electric feel
                        const o = ctx.createOscillator();
                        const lfo = ctx.createOscillator();
                        const lfoGain = ctx.createGain();
                        const flt = ctx.createBiquadFilter();
                        flt.type = 'bandpass';
                        flt.frequency.setValueAtTime(2000, now);
                        flt.frequency.exponentialRampToValueAtTime(500, now + 0.2);
                        flt.Q.setValueAtTime(8, now);
                        const g = ctx.createGain();
                        o.type = 'sawtooth';
                        o.frequency.setValueAtTime(600, now);
                        o.frequency.exponentialRampToValueAtTime(200, now + 0.2);
                        lfo.type = 'square';
                        lfo.frequency.setValueAtTime(40, now);
                        lfoGain.gain.setValueAtTime(200, now);
                        lfo.connect(lfoGain); lfoGain.connect(o.frequency);
                        g.gain.setValueAtTime(0.06, now);
                        g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                        o.connect(flt); flt.connect(g); g.connect(ctx.destination);
                        o.start(now); o.stop(now + 0.2);
                        lfo.start(now); lfo.stop(now + 0.2);
                        // High crackle
                        this._createNoise(ctx, 0.15, 6000, 'highpass', 0.04, now + 0.02);
                        break;
                    }
                    case 'bfg': {
                        // Massive: layered noise + sub bass chord + filtered sweep
                        this._createNoise(ctx, 0.8, 300, 'lowpass', 0.22, now);
                        this._createNoise(ctx, 0.6, 1500, 'bandpass', 0.1, now);
                        this._createNoise(ctx, 0.5, 5000, 'highpass', 0.04, now + 0.1);
                        // Sub bass chord
                        [35, 52, 70].forEach(freq => {
                            this._createDistortedOsc(ctx, 'sawtooth', freq, freq * 0.4, 0.7, 0.12, now);
                        });
                        // Rising then falling sweep
                        const sw = ctx.createOscillator();
                        const sf = ctx.createBiquadFilter();
                        sf.type = 'lowpass';
                        sf.frequency.setValueAtTime(500, now);
                        sf.frequency.exponentialRampToValueAtTime(3000, now + 0.3);
                        sf.frequency.exponentialRampToValueAtTime(100, now + 0.7);
                        const sg = ctx.createGain();
                        sw.type = 'sawtooth';
                        sw.frequency.setValueAtTime(80, now);
                        sw.frequency.exponentialRampToValueAtTime(200, now + 0.3);
                        sw.frequency.exponentialRampToValueAtTime(40, now + 0.7);
                        sg.gain.setValueAtTime(0.08, now);
                        sg.gain.exponentialRampToValueAtTime(0.001, now + 0.7);
                        sw.connect(sf); sf.connect(sg); sg.connect(ctx.destination);
                        sw.start(now); sw.stop(now + 0.7);
                        break;
                    }
                    case 'shotgun': {
                        // Double-barrel blast: two noise bursts + sub thump
                        for (let i = 0; i < 2; i++) {
                            const t = now + i * 0.07;
                            this._createNoise(ctx, 0.15, 600, 'lowpass', 0.2, t);
                            this._createNoise(ctx, 0.1, 4000, 'highpass', 0.08, t);
                            this._createDistortedOsc(ctx, 'sine', 100, 25, 0.12, 0.15, t);
                        }
                        // Ringing tail
                        this._createNoise(ctx, 0.3, 2000, 'bandpass', 0.03, now + 0.15);
                        break;
                    }
                }
            },

            // Toast system
            showToast(title, subtitle) {
                const id = this.toastId++;
                this.toasts.push({ id, title, subtitle, exiting: false });
                this.playSound('achievement');
                setTimeout(() => {
                    const idx = this.toasts.findIndex(t => t.id === id);
                    if (idx !== -1) {
                        this.toasts[idx].exiting = true;
                        setTimeout(() => {
                            this.toasts = this.toasts.filter(t => t.id !== id);
                        }, 300);
                    }
                }, 3000);
            },

            checkAchievements() {
                const count = this.allResults.length;
                const sourcesUp = this.sourceInfo.filter(s => s.count > 0).length;

                if (!this.achievements.firstBlood) {
                    this.achievements.firstBlood = true;
                    this.showToast('FIRST BLOOD', 'The hunt begins...');
                }
                if (!this.achievements.godlike && count >= 50) {
                    this.achievements.godlike = true;
                    setTimeout(() => this.showToast('GODLIKE', 'The marketplace trembles'), 800);
                } else if (!this.achievements.overkill && count >= 20) {
                    this.achievements.overkill = true;
                    setTimeout(() => this.showToast('OVERKILL', count + ' targets acquired'), 800);
                }
                if (!this.achievements.quadDamage && sourcesUp === 4) {
                    this.achievements.quadDamage = true;
                    setTimeout(() => this.showToast('QUAD DAMAGE', 'Full arsenal online'), 1600);
                } else if (!this.achievements.multiKill && sourcesUp >= 3) {
                    this.achievements.multiKill = true;
                    setTimeout(() => this.showToast('MULTI KILL', sourcesUp + ' sources dominated'), 1600);
                }
                if (!this.achievements.bargainHunter && count > 0) {
                    const cheapest = Math.min(...this.allResults.map(v => v.price));
                    if (cheapest < 5000) {
                        this.achievements.bargainHunter = true;
                        setTimeout(() => this.showToast('BARGAIN HUNTER', 'Steal of the century'), 2400);
                    }
                }
                if (!this.achievements.headshot && this.params.make && this.params.model && count > 0) {
                    const maxP = parseInt(this.params.max_price);
                    const match = this.allResults.find(v => {
                        const t = v.title.toLowerCase();
                        return t.includes(this.params.make.toLowerCase()) &&
                               t.includes(this.params.model.toLowerCase()) &&
                               v.price <= maxP;
                    });
                    if (match) {
                        this.achievements.headshot = true;
                        setTimeout(() => this.showToast('HEADSHOT', 'Precision strike'), 3200);
                    }
                }
            },

            async search() {
                if (this.loading) return;
                this.playSound('fire');
                this.triggerShake();
                this.hudState = 'searching';
                this.searchCount++;
                this.loadingKey++;
                this.loadingComplete = { craigslist: false, cargurus: false, carscom: false, autotrader: false };

                // Simulate platform completion
                setTimeout(() => { this.loadingComplete.craigslist = true; }, 3000);
                setTimeout(() => { this.loadingComplete.cargurus = true; }, 6000);
                setTimeout(() => { this.loadingComplete.carscom = true; }, 9000);
                setTimeout(() => { this.loadingComplete.autotrader = true; }, 11000);

                this.loading = true;
                this.searched = true;
                this.error = null;
                this.allResults = [];
                this.filtered = [];
                this.sourceInfo = [];
                this.activeSource = 'all';
                this.marketSummary = null;
                this.marketLoading = false;
                this.dealBadges = {};

                const body = {
                    make: this.params.make,
                    model: this.params.model,
                    min_year: this.params.min_year || undefined,
                    max_year: this.params.max_year || undefined,
                    max_price: parseInt(this.params.max_price),
                    max_mileage: parseInt(this.params.max_mileage),
                    location: 'milwaukee',
                    zip_code: this.params.zip_code || '53202',
                };

                try {
                    const resp = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    const data = await resp.json();

                    if (data.success) {
                        this.allResults = data.vehicles || [];
                        this.sourceInfo = (data.sources || []).map(s => ({
                            ...s,
                            key: this.sourceKey(s.name),
                        }));
                        this.applySort();
                        this.hudState = this.allResults.length > 0 ? 'results' : 'normal';
                        if (this.allResults.length > 0) {
                            this.playSound('pickup');
                            this.triggerStatPop();
                        }
                        this.checkAchievements();
                        // Trigger AI market analysis and deal badges
                        this.fetchMarketSummary();
                        this.$nextTick(() => this.fetchDealBadges());
                    } else {
                        this.error = data.error || 'Search failed. Please try again.';
                        this.hudState = 'error';
                        this.triggerRedFlash();
                        this.playSound('damage');
                    }
                } catch (e) {
                    this.error = 'Could not connect to the search API. Please try again.';
                    this.hudState = 'error';
                    this.triggerRedFlash();
                    this.playSound('damage');
                    console.error(e);
                } finally {
                    this.loading = false;
                    this.loadingComplete = { craigslist: true, cargurus: true, carscom: true, autotrader: true };
                    setTimeout(() => {
                        if (this.hudState !== 'searching') this.hudState = 'normal';
                    }, 3000);
                }
            },

            async openModal(vehicle) {
                this.selected = vehicle;
                this.modalImgIdx = 0;
                this.extraDetails = {};
                this.detailLoading = true;
                this.modalTab = 'details';
                this.currentReview = null;
                this.reviewError = null;
                this.currentSafety = null;
                this.safetyError = null;
                document.body.style.overflow = 'hidden';

                // Auto-fetch AI review and safety data in background
                this.fetchReview();
                this.fetchSafety();

                this.modalImages = vehicle.image_url ? [vehicle.image_url] : [];

                const detailController = new AbortController();
                const detailTimeout = setTimeout(() => detailController.abort(), 15000);
                try {
                    const resp = await fetch('/api/details?url=' + encodeURIComponent(vehicle.url), {
                        signal: detailController.signal
                    });
                    clearTimeout(detailTimeout);
                    const data = await resp.json();
                    if (data.success && data.details) {
                        const d = data.details;
                        if (d.images && d.images.length > 0) {
                            this.modalImages = d.images;
                            this.modalImgIdx = 0;
                        } else if (d.image_url && this.modalImages.length === 0) {
                            this.modalImages = [d.image_url];
                        }
                        const extras = {};
                        if (d.condition) extras['Condition'] = d.condition;
                        if (d.transmission) extras['Transmission'] = d.transmission;
                        if (d.fuel) extras['Fuel'] = d.fuel;
                        if (d.drive) extras['Drivetrain'] = d.drive;
                        if (d.color) extras['Color'] = d.color;
                        if (d.interior_color) extras['Interior'] = d.interior_color;
                        if (d.vin) extras['VIN'] = d.vin;
                        if (d.mpg) extras['MPG'] = d.mpg;
                        if (d.cylinders) extras['Cylinders'] = d.cylinders;
                        if (d.type) extras['Body Type'] = d.type;
                        if (d.title_status) extras['Title'] = d.title_status;
                        if (d.description) extras['description'] = d.description;
                        this.extraDetails = extras;
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        console.error('Details fetch timed out');
                    } else {
                        console.error('Details fetch failed:', e);
                    }
                } finally {
                    this.detailLoading = false;
                }
            },

            closeModal() {
                this.selected = null;
                this.modalImages = [];
                this.extraDetails = {};
                this.descCollapsed = true;
                this.modalTab = 'details';
                document.body.style.overflow = '';
            },

            saveCurrentSearch() {
                if (!this.params.make && !this.params.model) return;
                const search = {
                    id: Date.now(),
                    params: { ...this.params },
                    label: [this.params.make, this.params.model, this.params.min_year ? this.params.min_year + '+' : ''].filter(Boolean).join(' '),
                    savedAt: new Date().toISOString()
                };
                this.savedSearches = [search, ...this.savedSearches.slice(0, 9)];
                localStorage.setItem('mvf-saved-searches', JSON.stringify(this.savedSearches));
            },

            loadSavedSearch(search) {
                this.params = { ...search.params };
                this.showSavedSearches = false;
                this.search();
            },

            deleteSavedSearch(id) {
                this.savedSearches = this.savedSearches.filter(s => s.id !== id);
                localStorage.setItem('mvf-saved-searches', JSON.stringify(this.savedSearches));
            },

            toggleFavorite(vehicle) {
                const idx = this.favorites.findIndex(f => f.id === vehicle.id);
                if (idx >= 0) {
                    this.favorites.splice(idx, 1);
                } else {
                    this.favorites = [...this.favorites, { ...vehicle, favoritedAt: new Date().toISOString() }];
                }
                localStorage.setItem('mvf-favorites', JSON.stringify(this.favorites));
            },

            isFavorite(vehicleId) {
                return this.favorites.some(f => f.id === vehicleId);
            },

            shareListing(vehicle) {
                const text = vehicle.title + ' - $' + vehicle.price.toLocaleString() + '\n' + vehicle.url;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text);
                    this.toasts = [...this.toasts, { id: Date.now(), text: 'Link copied!', type: 'success' }];
                    setTimeout(() => this.toasts = this.toasts.slice(1), 3000);
                }
            },

            async fetchMarketSummary() {
                if (this.allResults.length === 0) return;
                this.marketError = null;
                this.marketLoading = true;
                this.marketExpanded = true;
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);
                try {
                    const resp = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        signal: controller.signal,
                        body: JSON.stringify({
                            vehicles: this.allResults.slice(0, 20).map(v => ({
                                title: v.title, price: v.price, year: v.year, mileage: v.mileage, source: v.source
                            })),
                            make: this.params.make,
                            model: this.params.model,
                            total_count: this.allResults.length
                        })
                    });
                    clearTimeout(timeout);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data && data.analysis) {
                            this.marketSummary = data.analysis;
                        }
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        this.marketError = 'Market analysis timed out. Try again later.';
                    } else {
                        this.marketError = 'Market analysis unavailable.';
                    }
                    console.error('Market analysis failed:', e);
                } finally {
                    this.marketLoading = false;
                }
            },

            async fetchDealBadges() {
                if (this.allResults.length === 0) return;
                const sorted = [...this.filtered].sort((a, b) => a.price - b.price);
                const top = sorted.slice(0, 10);

                // Process in batches of 3
                for (let i = 0; i < top.length; i += 3) {
                    const batch = top.slice(i, i + 3);
                    await Promise.all(batch.map(v => this._fetchSingleBadge(v)));
                    // Delay between batches (not after last)
                    if (i + 3 < top.length) {
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
            },

            async _fetchSingleBadge(v) {
                if (this.dealBadges[v.id]) return;
                try {
                    const info = this._parseVehicleInfo(v);
                    const make = info.make;
                    const model = info.model;
                    const year = info.year;
                    if (!make || !model || !year) return;
                    const key = 'review_' + (make + '_' + model + '_' + year).toLowerCase();
                    let review = this.reviewCache[key] || this._cacheGet(key);
                    if (!review) {
                        const resp = await fetch('/api/review', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ make, model, year: parseInt(year), price: v.price, mileage: v.mileage || 0 })
                        });
                        const data = await resp.json();
                        if (data.success !== false && data.review) {
                            review = data.review;
                            this.reviewCache[key] = review;
                            this._cacheSet(key, review);
                        }
                    }
                    if (review && review.price_verdict) {
                        const verdictMap = {
                            'great_deal': 'Great Deal',
                            'good_deal': 'Good Deal',
                            'fair': 'Fair',
                            'above_market': 'Above Market',
                            'overpriced': 'Overpriced'
                        };
                        this.dealBadges[v.id] = verdictMap[review.price_verdict] || review.price_verdict.replace(/_/g, ' ');
                    }
                } catch (e) {
                    // Skip failed badge fetches silently
                }
            },
        };
    }
    </script>
</body>
</html>
