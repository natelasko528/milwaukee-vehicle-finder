<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milwaukee Vehicle Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;500;600;700;800&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --background: oklch(0.8452 0 0);
            --foreground: oklch(0.2393 0 0);
            --card: oklch(0.7572 0 0);
            --card-foreground: oklch(0.2393 0 0);
            --primary: oklch(0.5016 0.1887 27.4816);
            --primary-foreground: oklch(1.0000 0 0);
            --secondary: oklch(0.4955 0.0896 126.1858);
            --secondary-foreground: oklch(1.0000 0 0);
            --muted: oklch(0.7826 0 0);
            --muted-foreground: oklch(0.4091 0 0);
            --accent: oklch(0.5880 0.0993 245.7394);
            --accent-foreground: oklch(1.0000 0 0);
            --destructive: oklch(0.7076 0.1975 46.4558);
            --border: oklch(0.4313 0 0);
            --input: oklch(0.4313 0 0);
            --ring: oklch(0.5016 0.1887 27.4816);
            --radius: 0px;
            --shadow-sm: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 1px 2px -1px hsl(0 0% 0% / 0.40);
            --shadow: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 1px 2px -1px hsl(0 0% 0% / 0.40);
            --shadow-md: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 2px 4px -1px hsl(0 0% 0% / 0.40);
            --shadow-lg: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 4px 6px -1px hsl(0 0% 0% / 0.40);
            --shadow-xl: 0px 2px 4px 0px hsl(0 0% 0% / 0.40), 0px 8px 10px -1px hsl(0 0% 0% / 0.40);
        }

        .dark {
            --background: oklch(0.2178 0 0);
            --foreground: oklch(0.9067 0 0);
            --card: oklch(0.2850 0 0);
            --card-foreground: oklch(0.9067 0 0);
            --primary: oklch(0.6083 0.2090 27.0276);
            --primary-foreground: oklch(1.0000 0 0);
            --secondary: oklch(0.6423 0.1467 133.0145);
            --secondary-foreground: oklch(0 0 0);
            --muted: oklch(0.2645 0 0);
            --muted-foreground: oklch(0.7058 0 0);
            --accent: oklch(0.7482 0.1235 244.7492);
            --accent-foreground: oklch(0 0 0);
            --destructive: oklch(0.7839 0.1719 68.0943);
            --border: oklch(0.4091 0 0);
            --input: oklch(0.4091 0 0);
            --ring: oklch(0.6083 0.2090 27.0276);
            --shadow-sm: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 1px 2px -1px hsl(0 0% 0% / 0.60);
            --shadow: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 1px 2px -1px hsl(0 0% 0% / 0.60);
            --shadow-md: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 2px 4px -1px hsl(0 0% 0% / 0.60);
            --shadow-lg: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 4px 6px -1px hsl(0 0% 0% / 0.60);
            --shadow-xl: 0px 2px 5px 0px hsl(0 0% 0% / 0.60), 0px 8px 10px -1px hsl(0 0% 0% / 0.60);
        }

        body {
            font-family: "Oxanium", sans-serif;
            background: var(--background);
            color: var(--foreground);
            line-height: 1.5;
        }

        /* ---- Header ---- */
        .header {
            background: var(--primary);
            color: var(--primary-foreground);
            padding: 2rem 1.5rem;
            text-align: center;
            border-bottom: 3px solid var(--border);
        }
        .header-inner {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-text { text-align: left; }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }
        .header p { opacity: 0.8; font-size: 0.85rem; font-weight: 400; }
        .theme-toggle {
            background: none;
            border: 2px solid var(--primary-foreground);
            color: var(--primary-foreground);
            width: 40px; height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            flex-shrink: 0;
            transition: opacity 0.15s;
        }
        .theme-toggle:hover { opacity: 0.7; }

        /* ---- Layout ---- */
        .container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }

        /* ---- Search Panel ---- */
        .search-panel {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            margin: -1rem auto 1.5rem;
            padding: 1.5rem;
            position: relative;
            z-index: 10;
        }
        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.3rem;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 0.5rem 0.6rem;
            border: 1px solid var(--border);
            font-family: "Oxanium", sans-serif;
            font-size: 0.85rem;
            color: var(--foreground);
            background: var(--background);
            transition: border-color 0.15s;
        }
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--ring);
        }
        .btn-search {
            width: 100%;
            padding: 0.7rem 1.5rem;
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            font-family: "Oxanium", sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        .btn-search:hover { opacity: 0.85; }
        .btn-search:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ---- Source Chips ---- */
        .sources-bar { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .source-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.7rem;
            font-size: 0.7rem;
            font-weight: 700;
            font-family: "Oxanium", sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            border: 1px solid var(--border);
            background: var(--muted);
            color: var(--muted-foreground);
            cursor: pointer;
            user-select: none;
            transition: all 0.15s;
        }
        .source-chip.active {
            border-color: var(--primary);
            background: var(--primary);
            color: var(--primary-foreground);
        }
        .source-chip .dot { width: 7px; height: 7px; flex-shrink: 0; }
        .dot-craigslist { background: oklch(0.55 0.15 300); }
        .dot-cargurus { background: oklch(0.55 0.15 245); }
        .dot-carscom { background: oklch(0.55 0.2 27); }
        .dot-autotrader { background: oklch(0.65 0.18 60); }

        /* ---- Stats Row ---- */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .stat-card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            text-align: center;
        }
        .stat-card .value { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .stat-card .label {
            font-size: 0.65rem;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-top: 0.15rem;
        }

        /* ---- Toolbar ---- */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .toolbar select {
            padding: 0.35rem 0.6rem;
            border: 1px solid var(--border);
            font-family: "Oxanium", sans-serif;
            font-size: 0.75rem;
            background: var(--card);
            color: var(--card-foreground);
        }

        /* ---- Vehicle Grid ---- */
        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .vehicle-card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s;
            display: flex;
            flex-direction: column;
        }
        .vehicle-card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }
        .card-image {
            width: 100%;
            height: 190px;
            background: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .card-image img { width: 100%; height: 100%; object-fit: cover; }
        .card-image .placeholder-icon { color: var(--muted-foreground); opacity: 0.4; }
        .card-source {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            padding: 0.2rem 0.55rem;
            font-family: "Oxanium", sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-foreground);
        }
        .badge-craigslist { background: oklch(0.45 0.14 300); }
        .badge-cargurus { background: oklch(0.45 0.14 245); }
        .badge-carscom { background: oklch(0.45 0.18 27); }
        .badge-autotrader { background: oklch(0.55 0.16 60); }

        .card-body { padding: 0.9rem; flex: 1; display: flex; flex-direction: column; }
        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }
        .card-meta {
            display: flex;
            gap: 0.8rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
            margin-top: auto;
        }
        .card-meta span { display: flex; align-items: center; gap: 0.2rem; }

        /* ---- Loading ---- */
        .loading-state { text-align: center; padding: 4rem 1rem; }
        .loading-spinner {
            width: 36px; height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-state p { color: var(--muted-foreground); font-size: 0.85rem; }
        .loading-sources {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.25rem;
            flex-wrap: wrap;
        }
        .loading-source {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }
        .loading-source .mini-spinner {
            width: 12px; height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        /* ---- Empty / Error ---- */
        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .empty-state .icon { color: var(--muted-foreground); opacity: 0.35; margin-bottom: 0.75rem; }
        .empty-state h3 { font-size: 1rem; margin-bottom: 0.25rem; }
        .empty-state p { font-size: 0.8rem; color: var(--muted-foreground); }

        /* ---- Modal ---- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            max-width: 580px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 0.6rem;
            right: 0.6rem;
            width: 30px; height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 1rem;
            color: var(--card-foreground);
            z-index: 5;
        }
        .modal-image {
            width: 100%;
            height: 300px;
            background: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .modal-image img { width: 100%; height: 100%; object-fit: cover; }
        .modal-image .placeholder-icon { color: var(--muted-foreground); opacity: 0.3; }
        .modal-image .img-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px; height: 30px;
            background: var(--card);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card-foreground);
        }
        .modal-image .img-nav.prev { left: 0.5rem; }
        .modal-image .img-nav.next { right: 0.5rem; }
        .modal-image .img-counter {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(0,0,0,0.65);
            color: #fff;
            font-family: "Source Code Pro", monospace;
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
        }
        .modal-body { padding: 1.25rem; }
        .modal-body .source-tag {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.6rem;
            font-weight: 700;
            font-family: "Oxanium", sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-foreground);
            margin-bottom: 0.4rem;
        }
        .modal-body h2 { font-size: 1.15rem; font-weight: 700; margin-bottom: 0.4rem; }
        .modal-body .price { font-size: 1.6rem; font-weight: 800; color: var(--secondary); margin-bottom: 0.75rem; }
        .modal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .detail-item {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 0.6rem;
        }
        .detail-item .dl {
            font-size: 0.6rem;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 600;
        }
        .detail-item .dv { font-size: 0.9rem; font-weight: 600; margin-top: 0.1rem; }
        .modal-desc {
            font-size: 0.8rem;
            color: var(--muted-foreground);
            line-height: 1.7;
            margin-bottom: 1rem;
            max-height: 160px;
            overflow-y: auto;
            white-space: pre-line;
            border: 1px solid var(--border);
            padding: 0.75rem;
            background: var(--background);
        }
        .btn-listing {
            display: block;
            width: 100%;
            padding: 0.7rem;
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            font-family: "Oxanium", sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: opacity 0.15s;
        }
        .btn-listing:hover { opacity: 0.85; }

        .detail-loading {
            text-align: center;
            padding: 0.6rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        /* ---- Footer ---- */
        .footer {
            text-align: center;
            padding: 2rem 1rem;
            font-size: 0.7rem;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        /* ---- Responsive ---- */
        @media (max-width: 640px) {
            .header h1 { font-size: 1.25rem; }
            .header-inner { flex-direction: row; }
            .search-grid { grid-template-columns: 1fr 1fr; }
            .vehicle-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .modal-details { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body x-data="app()" :class="{ dark: darkMode }">

    <!-- Header -->
    <div class="header">
        <div class="header-inner">
            <div class="header-text">
                <h1>Milwaukee Vehicle Finder</h1>
                <p>Search used cars across Craigslist, CarGurus, Cars.com &amp; AutoTrader</p>
            </div>
            <button class="theme-toggle" @click="toggleDark()" :title="darkMode ? 'Light mode' : 'Dark mode'">
                <svg x-show="!darkMode" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                <svg x-show="darkMode" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            </button>
        </div>
    </div>

    <div class="container">

        <!-- Search Panel -->
        <div class="search-panel">
            <div class="search-grid">
                <div class="form-group">
                    <label>Make</label>
                    <select x-model="params.make" @change="onMakeChange()">
                        <option value="">Any Make</option>
                        <template x-for="m in makes" :key="m">
                            <option :value="m" x-text="m"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Model</label>
                    <select x-model="params.model">
                        <option value="">Any Model</option>
                        <template x-for="m in availableModels" :key="m">
                            <option :value="m" x-text="m"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Min Year</label>
                    <select x-model="params.min_year">
                        <option value="">Any</option>
                        <template x-for="y in years" :key="'min'+y">
                            <option :value="y" x-text="y"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Year</label>
                    <select x-model="params.max_year">
                        <option value="">Any</option>
                        <template x-for="y in years" :key="'max'+y">
                            <option :value="y" x-text="y"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Price</label>
                    <select x-model="params.max_price">
                        <option value="5000">$5,000</option>
                        <option value="10000">$10,000</option>
                        <option value="15000">$15,000</option>
                        <option value="20000" selected>$20,000</option>
                        <option value="25000">$25,000</option>
                        <option value="30000">$30,000</option>
                        <option value="40000">$40,000</option>
                        <option value="50000">$50,000</option>
                        <option value="100000">$100,000</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Mileage</label>
                    <select x-model="params.max_mileage">
                        <option value="25000">25,000 mi</option>
                        <option value="50000">50,000 mi</option>
                        <option value="75000">75,000 mi</option>
                        <option value="100000">100,000 mi</option>
                        <option value="150000" selected>150,000 mi</option>
                        <option value="200000">200,000 mi</option>
                        <option value="999999">Any</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ZIP Code</label>
                    <input type="text" x-model="params.zip_code" maxlength="5" placeholder="53202">
                </div>
            </div>
            <button class="btn-search" @click="search()" :disabled="loading">
                <span x-show="!loading">Search Vehicles</span>
                <span x-show="loading">Searching...</span>
            </button>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Searching multiple platforms...</p>
            <div class="loading-sources">
                <div class="loading-source"><div class="mini-spinner"></div> Craigslist</div>
                <div class="loading-source"><div class="mini-spinner"></div> CarGurus</div>
                <div class="loading-source"><div class="mini-spinner"></div> Cars.com</div>
                <div class="loading-source"><div class="mini-spinner"></div> AutoTrader</div>
            </div>
        </div>

        <!-- Results -->
        <div x-show="!loading && searched">

            <!-- Stats -->
            <div class="stats-row" x-show="allResults.length > 0">
                <div class="stat-card">
                    <div class="value" x-text="filtered.length"></div>
                    <div class="label">Vehicles Found</div>
                </div>
                <div class="stat-card">
                    <div class="value" x-text="'$' + avgPrice.toLocaleString()"></div>
                    <div class="label">Avg Price</div>
                </div>
                <div class="stat-card">
                    <div class="value" x-text="bestDeal ? ('$' + bestDeal.toLocaleString()) : '-'"></div>
                    <div class="label">Lowest Price</div>
                </div>
                <div class="stat-card">
                    <div class="value" x-text="sourcesWithResults + '/' + sourcesTotal"></div>
                    <div class="label">Sources</div>
                </div>
            </div>

            <!-- Source Chips + Sort -->
            <div class="toolbar" x-show="allResults.length > 0">
                <div class="sources-bar">
                    <div class="source-chip" :class="{ active: activeSource === 'all' }" @click="activeSource = 'all'">
                        All
                        <span style="opacity:0.7" x-text="'(' + allResults.length + ')'"></span>
                    </div>
                    <template x-for="s in sourceInfo" :key="s.name">
                        <div class="source-chip"
                             :class="{ active: activeSource === s.name }"
                             @click="activeSource = s.name">
                            <span class="dot" :class="'dot-' + s.key"></span>
                            <span x-text="s.name"></span>
                            <span style="opacity:0.7" x-text="'(' + s.count + ')'"></span>
                        </div>
                    </template>
                </div>
                <div>
                    <select x-model="sortBy" @change="applySort()">
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="mileage-asc">Mileage: Low to High</option>
                        <option value="mileage-desc">Mileage: High to Low</option>
                        <option value="year-desc">Year: Newest First</option>
                        <option value="year-asc">Year: Oldest First</option>
                    </select>
                </div>
            </div>

            <!-- Grid -->
            <div class="vehicle-grid" x-show="filtered.length > 0">
                <template x-for="v in filtered" :key="v.id">
                    <div class="vehicle-card" @click="openModal(v)">
                        <div class="card-image">
                            <template x-if="v.image_url">
                                <img :src="v.image_url" :alt="v.title" loading="lazy"
                                     @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex'">
                            </template>
                            <div class="placeholder-icon" :style="v.image_url ? 'display:none' : ''">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M7 17a2 2 0 1 0 4 0 2 2 0 0 0-4 0Zm10 0a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"/>
                                    <path d="M5 17H3v-5l2-5h9l4 5h3v5h-2"/><path d="M5 12h14"/>
                                </svg>
                            </div>
                            <span class="card-source" :class="'badge-' + sourceKey(v.source)" x-text="v.source"></span>
                        </div>
                        <div class="card-body">
                            <div class="card-title" x-text="v.title"></div>
                            <div class="card-price" x-text="'$' + v.price.toLocaleString()"></div>
                            <div class="card-meta">
                                <span x-show="v.year">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    <span x-text="v.year"></span>
                                </span>
                                <span x-show="v.mileage">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <span x-text="v.mileage ? v.mileage.toLocaleString() + ' mi' : ''"></span>
                                </span>
                                <span x-show="v.location">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <span x-text="v.location"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div class="empty-state" x-show="allResults.length === 0 && !error">
                <div class="icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </div>
                <h3>No vehicles found</h3>
                <p>Try broadening your search criteria &mdash; increase max price, mileage, or year range.</p>
            </div>

            <!-- Filtered to 0 -->
            <div class="empty-state" x-show="allResults.length > 0 && filtered.length === 0">
                <div class="icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                </div>
                <h3>No results for this filter</h3>
                <p>Try selecting a different source.</p>
            </div>

            <!-- Error -->
            <div class="empty-state" x-show="error" style="border-left: 3px solid var(--destructive);">
                <h3 style="color: var(--destructive);">Search Error</h3>
                <p x-text="error"></p>
            </div>
        </div>
    </div>

    <div class="footer">Milwaukee Vehicle Finder &middot; Results scraped in real-time from public listings</div>

    <!-- Modal -->
    <template x-if="selected">
        <div class="modal-backdrop" @click.self="closeModal()" @keydown.escape.window="closeModal()">
            <div class="modal" @click.stop>
                <button class="modal-close" @click="closeModal()">&times;</button>

                <div class="modal-image">
                    <template x-if="modalImages.length > 0">
                        <img :src="modalImages[modalImgIdx]" :alt="selected.title"
                             @error="$event.target.style.display='none'">
                    </template>
                    <div class="placeholder-icon" x-show="modalImages.length === 0 && !detailLoading">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M7 17a2 2 0 1 0 4 0 2 2 0 0 0-4 0Zm10 0a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"/>
                            <path d="M5 17H3v-5l2-5h9l4 5h3v5h-2"/><path d="M5 12h14"/>
                        </svg>
                    </div>
                    <div class="loading-spinner" x-show="modalImages.length === 0 && detailLoading" style="position:absolute;"></div>
                    <template x-if="modalImages.length > 1">
                        <button class="img-nav prev" @click.stop="modalImgIdx = (modalImgIdx - 1 + modalImages.length) % modalImages.length">&lsaquo;</button>
                    </template>
                    <template x-if="modalImages.length > 1">
                        <button class="img-nav next" @click.stop="modalImgIdx = (modalImgIdx + 1) % modalImages.length">&rsaquo;</button>
                    </template>
                    <template x-if="modalImages.length > 1">
                        <div class="img-counter" x-text="(modalImgIdx + 1) + ' / ' + modalImages.length"></div>
                    </template>
                </div>

                <div class="modal-body">
                    <span class="source-tag" :class="'badge-' + sourceKey(selected.source)" x-text="selected.source"></span>
                    <h2 x-text="selected.title"></h2>
                    <div class="price" x-text="'$' + selected.price.toLocaleString()"></div>

                    <div class="modal-details">
                        <div class="detail-item" x-show="selected.year">
                            <div class="dl">Year</div>
                            <div class="dv" x-text="selected.year"></div>
                        </div>
                        <div class="detail-item" x-show="selected.mileage">
                            <div class="dl">Mileage</div>
                            <div class="dv" x-text="selected.mileage ? selected.mileage.toLocaleString() + ' mi' : '-'"></div>
                        </div>
                        <div class="detail-item" x-show="selected.location">
                            <div class="dl">Location</div>
                            <div class="dv" x-text="selected.location"></div>
                        </div>
                        <div class="detail-item" x-show="selected.source">
                            <div class="dl">Source</div>
                            <div class="dv" x-text="selected.source"></div>
                        </div>
                        <!-- Extra details from /api/details (excluding description) -->
                        <template x-for="(val, key) in extraDetails" :key="key">
                            <div class="detail-item" x-show="val && key !== 'description'">
                                <div class="dl" x-text="key"></div>
                                <div class="dv" x-text="val"></div>
                            </div>
                        </template>
                    </div>

                    <div class="detail-loading" x-show="detailLoading">Loading additional details...</div>

                    <div class="modal-desc" x-show="extraDetails.description" x-html="formatDescription(extraDetails.description)"></div>

                    <a class="btn-listing" :href="selected.url" target="_blank" rel="noopener">
                        View Full Listing &rarr;
                    </a>
                </div>
            </div>
        </div>
    </template>

    <script>
    function app() {
        return {
            loading: false,
            searched: false,
            error: null,
            allResults: [],
            filtered: [],
            activeSource: 'all',
            sortBy: 'price-asc',
            selected: null,
            modalImages: [],
            modalImgIdx: 0,
            detailLoading: false,
            extraDetails: {},
            sourceInfo: [],
            darkMode: false,

            params: {
                make: '',
                model: '',
                min_year: '',
                max_year: '',
                max_price: '20000',
                max_mileage: '150000',
                zip_code: '53202',
            },

            years: [],
            availableModels: [],

            makes: [
                'Acura','Audi','BMW','Buick','Cadillac','Chevrolet','Chrysler','Dodge',
                'Ford','GMC','Honda','Hyundai','Infiniti','Jeep','Kia','Lexus',
                'Lincoln','Mazda','Mercedes-Benz','Mitsubishi','Nissan','Ram','Subaru',
                'Tesla','Toyota','Volkswagen','Volvo'
            ],

            modelsByMake: {
                'Acura': ['ILX','TLX','RDX','MDX','Integra'],
                'Audi': ['A3','A4','A6','Q3','Q5','Q7','e-tron'],
                'BMW': ['3 Series','5 Series','7 Series','X1','X3','X5','X7'],
                'Buick': ['Encore','Envision','Enclave'],
                'Cadillac': ['CT4','CT5','XT4','XT5','XT6','Escalade'],
                'Chevrolet': ['Malibu','Camaro','Corvette','Equinox','Blazer','Traverse','Tahoe','Suburban','Silverado','Colorado'],
                'Chrysler': ['300','Pacifica','Voyager'],
                'Dodge': ['Charger','Challenger','Durango','Grand Caravan','Hornet'],
                'Ford': ['Fusion','Mustang','Escape','Edge','Explorer','Expedition','F-150','Ranger','Bronco','Maverick'],
                'GMC': ['Terrain','Acadia','Yukon','Sierra','Canyon'],
                'Honda': ['Civic','Accord','HR-V','CR-V','Pilot','Passport','Ridgeline','Odyssey','Fit'],
                'Hyundai': ['Accent','Elantra','Sonata','Kona','Tucson','Santa Fe','Palisade','Ioniq 5'],
                'Infiniti': ['Q50','Q60','QX50','QX60','QX80'],
                'Jeep': ['Renegade','Compass','Cherokee','Grand Cherokee','Wrangler','Gladiator'],
                'Kia': ['Forte','K5','Stinger','Soul','Seltos','Sportage','Sorento','Telluride','EV6'],
                'Lexus': ['IS','ES','NX','RX','GX','LX'],
                'Lincoln': ['Corsair','Nautilus','Aviator','Navigator'],
                'Mazda': ['Mazda3','Mazda6','CX-30','CX-5','CX-9','CX-50','MX-5 Miata'],
                'Mercedes-Benz': ['A-Class','C-Class','E-Class','S-Class','GLA','GLC','GLE','GLS'],
                'Mitsubishi': ['Mirage','Outlander','Eclipse Cross'],
                'Nissan': ['Versa','Sentra','Altima','Maxima','Kicks','Rogue','Murano','Pathfinder','Frontier','Titan'],
                'Ram': ['1500','2500','3500','ProMaster'],
                'Subaru': ['Impreza','Legacy','WRX','Crosstrek','Forester','Outback','Ascent'],
                'Tesla': ['Model 3','Model Y','Model S','Model X'],
                'Toyota': ['Corolla','Camry','Avalon','GR86','Supra','C-HR','RAV4','Highlander','4Runner','Sequoia','Tacoma','Tundra','Prius','Sienna'],
                'Volkswagen': ['Jetta','Passat','Golf','GTI','Tiguan','Atlas','ID.4','Taos'],
                'Volvo': ['S60','S90','XC40','XC60','XC90'],
            },

            init() {
                const cur = new Date().getFullYear() + 1;
                for (let y = cur; y >= 1990; y--) this.years.push(y);
                this.$watch('activeSource', () => this.applySort());

                // Persist dark mode
                if (localStorage.getItem('mvf-dark') === '1' ||
                    (!localStorage.getItem('mvf-dark') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    this.darkMode = true;
                }
            },

            toggleDark() {
                this.darkMode = !this.darkMode;
                localStorage.setItem('mvf-dark', this.darkMode ? '1' : '0');
            },

            onMakeChange() {
                const make = this.params.make;
                this.availableModels = make && this.modelsByMake[make] ? this.modelsByMake[make] : [];
                if (!this.availableModels.includes(this.params.model)) this.params.model = '';
            },

            sourceKey(name) {
                return {
                    'Craigslist': 'craigslist',
                    'CarGurus': 'cargurus',
                    'Cars.com': 'carscom',
                    'AutoTrader': 'autotrader',
                }[name] || 'craigslist';
            },

            formatDescription(text) {
                if (!text) return '';
                // Escape HTML entities for safety
                let s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                // Break up run-on text at sentence boundaries
                s = s.replace(/([.!?])(\s*)([A-Z])/g, '$1\n\n$3');
                // Break before common keywords
                s = s.replace(/(ADDRESS\s*:|LOCATION\s*:|CALL\s|CONTACT\s|TEXT\s|PHONE\s*:)/gi, '\n\n$1');
                // Break before URLs
                s = s.replace(/(https?:\/\/|www\.)/gi, '\n\n$1');
                // Break long comma-separated feature lists into bullets
                s = s.replace(/,\s*([A-Z]{2,})/g, '\n- $1');
                // Collapse excessive blank lines
                s = s.replace(/\n{3,}/g, '\n\n');
                return s.trim();
            },

            get avgPrice() {
                if (this.filtered.length === 0) return 0;
                return Math.round(this.filtered.reduce((s, v) => s + v.price, 0) / this.filtered.length);
            },

            get bestDeal() {
                if (this.filtered.length === 0) return null;
                return Math.min(...this.filtered.map(v => v.price));
            },

            get sourcesWithResults() {
                return this.sourceInfo.filter(s => s.count > 0).length;
            },

            get sourcesTotal() {
                return this.sourceInfo.length;
            },

            applySort() {
                let list = this.allResults;
                if (this.activeSource !== 'all') {
                    list = list.filter(v => v.source === this.activeSource);
                }
                this.filtered = [...list];
                const [field, dir] = this.sortBy.split('-');
                const asc = dir === 'asc';
                this.filtered.sort((a, b) => {
                    let va, vb;
                    if (field === 'price') { va = a.price || 0; vb = b.price || 0; }
                    else if (field === 'mileage') { va = a.mileage || 999999; vb = b.mileage || 999999; }
                    else if (field === 'year') { va = a.year || 0; vb = b.year || 0; }
                    return asc ? va - vb : vb - va;
                });
            },

            async search() {
                this.loading = true;
                this.searched = true;
                this.error = null;
                this.allResults = [];
                this.filtered = [];
                this.sourceInfo = [];
                this.activeSource = 'all';

                const body = {
                    make: this.params.make,
                    model: this.params.model,
                    min_year: this.params.min_year || undefined,
                    max_year: this.params.max_year || undefined,
                    max_price: parseInt(this.params.max_price),
                    max_mileage: parseInt(this.params.max_mileage),
                    location: 'milwaukee',
                    zip_code: this.params.zip_code || '53202',
                };

                try {
                    const resp = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    const data = await resp.json();

                    if (data.success) {
                        this.allResults = data.vehicles || [];
                        this.sourceInfo = (data.sources || []).map(s => ({
                            ...s,
                            key: this.sourceKey(s.name),
                        }));
                        this.applySort();
                    } else {
                        this.error = data.error || 'Search failed. Please try again.';
                    }
                } catch (e) {
                    this.error = 'Could not connect to the search API. Please try again.';
                    console.error(e);
                } finally {
                    this.loading = false;
                }
            },

            async openModal(vehicle) {
                this.selected = vehicle;
                this.modalImgIdx = 0;
                this.extraDetails = {};
                this.detailLoading = true;
                document.body.style.overflow = 'hidden';

                this.modalImages = vehicle.image_url ? [vehicle.image_url] : [];

                try {
                    const resp = await fetch('/api/details?url=' + encodeURIComponent(vehicle.url));
                    const data = await resp.json();
                    if (data.success && data.details) {
                        const d = data.details;
                        if (d.images && d.images.length > 0) {
                            this.modalImages = d.images;
                            this.modalImgIdx = 0;
                        } else if (d.image_url && this.modalImages.length === 0) {
                            this.modalImages = [d.image_url];
                        }
                        const extras = {};
                        if (d.condition) extras['Condition'] = d.condition;
                        if (d.transmission) extras['Transmission'] = d.transmission;
                        if (d.fuel) extras['Fuel'] = d.fuel;
                        if (d.drive) extras['Drivetrain'] = d.drive;
                        if (d.color) extras['Color'] = d.color;
                        if (d.interior_color) extras['Interior'] = d.interior_color;
                        if (d.vin) extras['VIN'] = d.vin;
                        if (d.mpg) extras['MPG'] = d.mpg;
                        if (d.cylinders) extras['Cylinders'] = d.cylinders;
                        if (d.type) extras['Body Type'] = d.type;
                        if (d.title_status) extras['Title'] = d.title_status;
                        if (d.description) extras['description'] = d.description;
                        this.extraDetails = extras;
                    }
                } catch (e) {
                    console.error('Details fetch failed:', e);
                } finally {
                    this.detailLoading = false;
                }
            },

            closeModal() {
                this.selected = null;
                this.modalImages = [];
                this.extraDetails = {};
                document.body.style.overflow = '';
            },
        };
    }
    </script>
</body>
</html>
